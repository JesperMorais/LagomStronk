---
phase: 03-workout-features
plan: 05
type: execute
---

<objective>
Add configurable rest timer with media session controls for lock screen usage.

Purpose: Help users track rest between sets without leaving the app or checking their phone.
Output: Rest timer UI, configurable duration, media session integration for lock screen controls.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workout-features/03-CONTEXT.md

**Note from context:** Rest timer is "nice-to-have if scope allows" - deprioritized vs programs

**Technical approach:**
- Media Session API for lock screen controls (play/pause)
- Silent audio track trick to keep media session active
- Vibration alert when timer completes
- Common rest times: 60s, 90s, 120s, 180s

**Existing patterns:**
- Workout timer already exists (elapsed time)
- Canvas-confetti for celebrations
- Haptic feedback pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rest timer UI to workout view</name>
  <files>index.html, css/style.css</files>
  <action>
Add rest timer section to workout view, after the main timer:

HTML (add inside workout-view, near timer):
```html
<div id="rest-timer" class="rest-timer" style="display: none;">
  <div class="rest-timer__display">
    <span class="rest-timer__time">1:30</span>
  </div>
  <div class="rest-timer__controls">
    <button class="rest-timer__btn rest-timer__btn--adjust" data-adjust="-15">-15s</button>
    <button class="rest-timer__btn rest-timer__btn--toggle" id="rest-timer-toggle">
      <span class="rest-timer__pause-icon">‚è∏</span>
    </button>
    <button class="rest-timer__btn rest-timer__btn--adjust" data-adjust="+15">+15s</button>
  </div>
  <div class="rest-timer__presets">
    <button class="rest-timer__preset" data-seconds="60">1:00</button>
    <button class="rest-timer__preset" data-seconds="90">1:30</button>
    <button class="rest-timer__preset" data-seconds="120">2:00</button>
    <button class="rest-timer__preset" data-seconds="180">3:00</button>
  </div>
</div>
```

CSS:
```css
.rest-timer {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 20px;
  margin: 16px;
  text-align: center;
}

.rest-timer__display {
  margin-bottom: 16px;
}

.rest-timer__time {
  font-size: 56px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  color: var(--mint);
}

.rest-timer.complete .rest-timer__time {
  animation: timerPulse 0.5s ease infinite;
}

@keyframes timerPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.rest-timer__controls {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin-bottom: 16px;
}

.rest-timer__btn {
  background: var(--bg-secondary);
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  font-size: 14px;
  cursor: pointer;
  color: var(--text-primary);
}

.rest-timer__btn--toggle {
  width: 64px;
  height: 64px;
  background: var(--mint);
  color: var(--bg-primary);
  font-size: 24px;
}

.rest-timer__presets {
  display: flex;
  justify-content: center;
  gap: 8px;
}

.rest-timer__preset {
  background: transparent;
  border: 1px solid var(--border-color);
  border-radius: 20px;
  padding: 6px 14px;
  font-size: 13px;
  color: var(--text-secondary);
  cursor: pointer;
}

.rest-timer__preset.active {
  background: var(--mint);
  border-color: var(--mint);
  color: var(--bg-primary);
}
```

Timer shows when set is completed, auto-starts, pulses when complete.
  </action>
  <verify>grep "rest-timer" index.html && grep "rest-timer" css/style.css</verify>
  <done>Rest timer UI structure and styling complete</done>
</task>

<task type="auto">
  <name>Task 2: Implement rest timer logic and controls</name>
  <files>js/app.js</files>
  <action>
Add rest timer state and functions:

1. Rest timer state:
```javascript
let restTimer = {
  isRunning: false,
  remainingSeconds: 90,
  defaultSeconds: 90,
  intervalId: null
};
```

2. startRestTimer(seconds = restTimer.defaultSeconds):
   - Set remainingSeconds
   - Start interval that decrements every second
   - Update display
   - When reaches 0: play completion sound, vibrate, show "REST COMPLETE"

3. pauseRestTimer():
   - Clear interval
   - Set isRunning = false
   - Update toggle button to play icon

4. resumeRestTimer():
   - Resume interval
   - Update toggle button to pause icon

5. adjustRestTimer(seconds):
   - Add/subtract seconds from remaining
   - Min 0, max 600 (10 min)

6. setRestTimerPreset(seconds):
   - Set defaultSeconds
   - If timer not running, also set remainingSeconds
   - Highlight selected preset

7. Event listeners:
   - Toggle button: pause/resume
   - Adjust buttons: +15s/-15s
   - Preset buttons: set duration
   - Auto-start when set marked complete (call from toggleSetCompletion)

8. formatRestTime(seconds): Return "M:SS" format
  </action>
  <verify>grep "startRestTimer" js/app.js && grep "restTimer" js/app.js</verify>
  <done>Rest timer logic with start/pause/adjust/preset controls working</done>
</task>

<task type="auto">
  <name>Task 3: Add Media Session API for lock screen controls</name>
  <files>js/app.js</files>
  <action>
Integrate Media Session API for lock screen control:

1. Create silent audio element (for keeping media session active):
```javascript
let silentAudio = null;

function initSilentAudio() {
  // Create a very short silent audio to activate media session
  silentAudio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=');
  silentAudio.loop = true;
}
```

2. setupMediaSession() when rest timer starts:
```javascript
function setupMediaSession() {
  if ('mediaSession' in navigator) {
    navigator.mediaSession.metadata = new MediaMetadata({
      title: 'Rest Timer',
      artist: 'LagomStronk',
      album: 'Workout'
    });

    navigator.mediaSession.setActionHandler('play', () => {
      resumeRestTimer();
    });

    navigator.mediaSession.setActionHandler('pause', () => {
      pauseRestTimer();
    });

    // Start silent audio to activate media controls
    if (silentAudio) {
      silentAudio.play().catch(() => {});
    }
  }
}
```

3. Call setupMediaSession() in startRestTimer()

4. Clear media session when timer completes or is cancelled:
```javascript
function clearMediaSession() {
  if (silentAudio) {
    silentAudio.pause();
  }
  if ('mediaSession' in navigator) {
    navigator.mediaSession.metadata = null;
  }
}
```

5. Timer completion:
   - Vibrate pattern: [200, 100, 200, 100, 200]
   - Show notification if page not visible (optional, needs permission)
   - Clear media session

This allows play/pause from lock screen on both iOS and Android.
  </action>
  <verify>Start rest timer, lock phone, verify media controls appear on lock screen</verify>
  <done>Media Session API integrated for lock screen rest timer control</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Rest timer with lock screen controls</what-built>
  <how-to-verify>
    1. Run local server and open app
    2. Start a workout, add exercise, complete a set
    3. Verify: Rest timer appears and auto-starts after set completion
    4. Verify: Timer counts down, display updates every second
    5. Test +15s/-15s buttons - timer adjusts
    6. Test preset buttons (1:00, 1:30, 2:00, 3:00)
    7. Test pause/resume toggle
    8. Let timer reach 0 - verify vibration and visual feedback
    9. Lock phone (if testing on mobile) - verify media controls appear
    10. Use lock screen controls to pause/resume timer
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Rest timer UI appears after set completion
- [ ] Timer counts down and updates display
- [ ] Pause/resume, adjust, and preset controls work
- [ ] Timer completion triggers vibration
- [ ] Media Session shows on lock screen (mobile browsers that support it)
- [ ] Lock screen controls pause/resume timer
- [ ] No console errors
</verification>

<success_criteria>
- All tasks completed
- Rest timer is usable and intuitive
- Lock screen controls work on supported browsers
- Timer integrates naturally into workout flow
- Graceful degradation on unsupported browsers
</success_criteria>

<output>
After completion, create `.planning/phases/03-workout-features/03-05-SUMMARY.md`
</output>
