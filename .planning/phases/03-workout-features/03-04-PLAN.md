---
phase: 03-workout-features
plan: 04
type: execute
---

<objective>
Add real-time PR detection during workouts with celebration animations.

Purpose: Make achieving personal records feel rewarding with instant feedback.
Output: PR detection logic during set logging, celebration UI with animations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workout-features/03-CONTEXT.md
@.planning/phases/03-workout-features/03-01-SUMMARY.md

**Existing PR infrastructure:**
- getPersonalRecords(data) returns { exercise: { maxWeight, maxVolume, maxReps } }
- getEstimated1RMs(data) returns estimated 1RM for each exercise
- calculateEstimated1RM(weight, reps) calculates 1RM from any set

**Existing celebration patterns from Phase 2:**
- canvas-confetti already loaded (CDN)
- Set completion has checkmark animation and confetti
- Haptic feedback pattern via navigator.vibrate
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add real-time PR detection function</name>
  <files>js/data.js</files>
  <action>
Add function to detect if a set is a PR:

```javascript
// Check if a set represents a new personal record
// Returns array of PR types achieved: ['weight', 'volume', 'reps', 'e1rm']
export function checkForPR(data, exerciseName, newSet, todayDate) {
  const prs = [];
  const existingPRs = getPersonalRecords(data);
  const exercisePRs = existingPRs[exerciseName];

  // If no history, first attempt is always a PR
  if (!exercisePRs) {
    return ['weight']; // First workout is a weight PR
  }

  // Check weight PR (excluding today's workout)
  if (newSet.weight > exercisePRs.maxWeight.value) {
    prs.push('weight');
  }

  // Check volume PR for this exercise (single set volume = reps √ó weight)
  const setVolume = newSet.reps * newSet.weight;
  // Note: maxVolume is total exercise volume, not single set
  // For single set volume PR, we'd need different tracking

  // Check estimated 1RM PR
  const newE1RM = calculateEstimated1RM(newSet.weight, newSet.reps);
  const existingE1RMs = getEstimated1RMs(data);
  const exerciseE1RM = existingE1RMs[exerciseName];
  if (!exerciseE1RM || newE1RM > exerciseE1RM.value) {
    prs.push('e1rm');
  }

  return prs;
}
```

Export the function. PR types:
- 'weight': Heaviest weight ever for this exercise
- 'e1rm': Highest estimated 1RM (calculated from weight √ó reps)
- Future: 'reps' for most reps at same weight, 'volume' for session volume

Keep it simple - weight PR and e1RM PR are the most meaningful for strength training.
  </action>
  <verify>grep "checkForPR" js/data.js</verify>
  <done>checkForPR function returns array of PR types achieved</done>
</task>

<task type="auto">
  <name>Task 2: Add PR celebration UI component</name>
  <files>index.html, css/style.css, js/app.js</files>
  <action>
Create PR celebration overlay that shows when a PR is detected:

1. HTML (add before </body>):
```html
<div id="pr-celebration" class="pr-celebration" style="display: none;">
  <div class="pr-celebration__content">
    <div class="pr-celebration__icon">üèÜ</div>
    <div class="pr-celebration__title">NEW PR!</div>
    <div class="pr-celebration__exercise"></div>
    <div class="pr-celebration__value"></div>
    <div class="pr-celebration__type"></div>
  </div>
</div>
```

2. CSS:
```css
.pr-celebration {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  animation: prFadeIn 0.3s ease;
}

@keyframes prFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.pr-celebration__content {
  text-align: center;
  animation: prBounce 0.5s ease;
}

@keyframes prBounce {
  0% { transform: scale(0.5); opacity: 0; }
  60% { transform: scale(1.1); }
  100% { transform: scale(1); opacity: 1; }
}

.pr-celebration__icon {
  font-size: 64px;
  margin-bottom: 16px;
  animation: prShake 0.5s ease 0.3s;
}

@keyframes prShake {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(-10deg); }
  75% { transform: rotate(10deg); }
}

.pr-celebration__title {
  font-size: 32px;
  font-weight: 800;
  color: var(--mint);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.pr-celebration__exercise {
  font-size: 18px;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.pr-celebration__value {
  font-size: 48px;
  font-weight: 700;
  color: white;
  margin-bottom: 4px;
}

.pr-celebration__type {
  font-size: 14px;
  color: var(--mint);
  text-transform: uppercase;
}
```

3. JS - showPRCelebration(exerciseName, value, prType):
   - Show the overlay
   - Set exercise name, value (e.g., "100kg"), type (e.g., "Weight PR")
   - Fire confetti (50 particles, gold + mint colors)
   - Haptic feedback (longer vibration: 100ms)
   - Auto-dismiss after 2.5 seconds
   - Tap anywhere to dismiss early
  </action>
  <verify>grep "pr-celebration" index.html && grep "showPRCelebration" js/app.js</verify>
  <done>PR celebration overlay with animations working</done>
</task>

<task type="auto">
  <name>Task 3: Integrate PR detection into set completion flow</name>
  <files>js/app.js</files>
  <action>
Hook PR detection into the set completion flow:

1. Import checkForPR from data.js

2. Modify toggleSetCompletion() or wherever sets are marked complete:
   - After marking set complete, get the set's weight and reps
   - Call checkForPR(appData, exerciseName, { weight, reps }, currentDate)
   - If result array is not empty, show celebration:
     - Priority: 'weight' > 'e1rm' (show weight if both)
     - Format value: "100kg" for weight, "Est. 120kg" for e1rm

3. Add small PR badge to completed sets that were PRs:
```html
<span class="pr-badge">PR</span>
```
```css
.pr-badge {
  background: var(--mint);
  color: var(--bg-primary);
  font-size: 10px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 4px;
  margin-left: 8px;
}
```

4. Only check for PR on sets that are actually logged (have weight > 0 and reps > 0)

This creates the celebratory moment when users hit PRs naturally during their workout.
  </action>
  <verify>Complete a set with higher weight than ever before - PR celebration should appear</verify>
  <done>PR detection triggers celebration during normal workout flow</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Real-time PR detection with celebration animations</what-built>
  <how-to-verify>
    1. Run local server and open app
    2. Start a workout with an exercise you have history for
    3. Enter a set with HIGHER weight than your previous best
    4. Mark the set complete (checkbox)
    5. Verify: PR celebration overlay appears with confetti
    6. Verify: Trophy icon, "NEW PR!", exercise name, value shown
    7. Verify: Overlay auto-dismisses after ~2.5 seconds (or tap to dismiss)
    8. Verify: Set row shows small "PR" badge
    9. Try a set with lower weight - verify NO celebration (not a PR)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] checkForPR correctly identifies weight and e1RM PRs
- [ ] PR celebration shows with animations and confetti
- [ ] Celebration auto-dismisses and is tap-dismissible
- [ ] PR badge appears on completed PR sets
- [ ] False positives avoided (only real PRs trigger celebration)
- [ ] No console errors
</verification>

<success_criteria>
- All tasks completed
- PRs detected in real-time during workout
- Celebration is satisfying but not intrusive
- Visual feedback (badge) persists on PR sets
- Works with existing set completion flow
</success_criteria>

<output>
After completion, create `.planning/phases/03-workout-features/03-04-SUMMARY.md`
</output>
