---
phase: 01-technical-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - js/app.js
  - index.html
autonomous: false

must_haves:
  truths:
    - "App initializes storage and runs migration on load"
    - "Migration failure shows error toast with retry button"
    - "Storage capacity is checked after app initialization"
    - "App works correctly with migrated IndexedDB data"
    - "User can retry failed migration via toast button"
  artifacts:
    - path: "js/app.js"
      provides: "App initialization with async storage"
      contains: "async function init"
  key_links:
    - from: "js/app.js"
      to: "js/data/migration.js"
      via: "calls migrateToIndexedDB on init"
      pattern: "await migrateToIndexedDB"
    - from: "js/app.js"
      to: "js/core/storageMonitor.js"
      via: "calls checkStorageCapacity"
      pattern: "await checkStorageCapacity"
    - from: "js/app.js"
      to: "js/ui/toast.js"
      via: "imports for migration error toast"
      pattern: "import.*toast"
---

<objective>
Wire all Phase 1 infrastructure together: initialize storage, run migration, check capacity, and handle errors with retry.

Purpose: This completes Phase 1 by integrating all modules into the app startup flow. After this plan, the app uses IndexedDB with migration, capacity monitoring, and toast notifications.

Output: Fully integrated async app initialization with all Phase 1 features working.
</objective>

<execution_context>
@/home/david/.claude/get-shit-done/workflows/execute-plan.md
@/home/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/01-technical-foundation/01-CONTEXT.md
@.planning/phases/01-technical-foundation/01-02-SUMMARY.md
@.planning/phases/01-technical-foundation/01-03-SUMMARY.md
@js/app.js
@js/core/storage.js
@js/data/migration.js
@js/core/storageMonitor.js
@js/ui/toast.js
@js/data.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update app.js with async initialization</name>
  <files>
    - js/app.js
  </files>
  <action>
1. Add new imports at the top of app.js (after existing imports):
   ```javascript
   import { initializeStorage } from './core/storage.js';
   import { migrateToIndexedDB, retryMigration } from './data/migration.js';
   import { checkStorageCapacity } from './core/storageMonitor.js';
   import { showMigrationError } from './ui/toast.js';
   import { eventBus, EVENTS } from './core/eventBus.js';
   ```

2. Change the app state initialization:
   - Current: `let appData = loadData();`
   - Change to: `let appData = null;` (will be loaded async)

3. Convert `init()` to async and add startup sequence:
   ```javascript
   async function init() {
     try {
       // 1. Initialize storage (check if already migrated)
       await initializeStorage();

       // 2. Run migration (silent, skips if already done)
       const migrationResult = await migrateToIndexedDB();

       if (!migrationResult.success) {
         // Show error toast with retry button
         showMigrationError(migrationResult.error, async () => {
           const retryResult = await retryMigration();
           if (retryResult.success) {
             // Reload app after successful retry
             window.location.reload();
           } else {
             showMigrationError(retryResult.error, null);
           }
         });
         // Continue loading with localStorage fallback (initializeStorage handles this)
       }

       // 3. Load app data (now async)
       appData = await loadData();

       // 4. Check storage capacity (emits events if thresholds exceeded)
       await checkStorageCapacity();

       // 5. Continue with existing initialization
       setupNavigation();
       setupEventListeners();
       renderTodayView();
       updateTodayDate();

     } catch (error) {
       console.error('App initialization failed:', error);
       // Fallback: try to load with localStorage
       appData = await loadData();
       setupNavigation();
       setupEventListeners();
       renderTodayView();
       updateTodayDate();
     }
   }
   ```

4. Update all functions that use appData to handle async saveData:

   The following functions call saveData and need to await it:

   In `saveExercise()`:
   - After `appData = addExerciseToWorkout(...)` add: `await` before the call
   - After `saveData(appData)` add: `await` before the call
   - Make function async

   In `window.deleteExercise`:
   - `appData = removeExerciseFromWorkout(...)` - add await, make async

   In `saveCustomExercise()`:
   - `appData = addCustomExercise(...)` - add await, make async

   In `window.deleteFromLibrary`:
   - `appData = removeExerciseFromLibrary(...)` - add await, make async

   In `saveTemplate()`:
   - `appData = addWorkoutTemplate(...)` - add await, make async

   In `startTemplateWorkout()`:
   - `appData = applyWorkoutTemplate(...)` - add await, make async

   In `deleteTemplate()`:
   - `appData = deleteWorkoutTemplate(...)` - add await, make async

   In `confirmSaveAsTemplate()`:
   - `appData = saveWorkoutAsTemplate(...)` - add await, make async

   In `window.editExercise`:
   - After modifying workout.exercises, the `saveData(appData)` call - add await, make async

5. Remove the duplicate STORAGE_KEY constant if present (it's now in storage.js).

6. At the bottom of the file, change `init()` call to handle async:
   ```javascript
   // Initialize the app
   init().catch(err => console.error('Failed to initialize app:', err));
   ```
  </action>
  <verify>
    - app.js imports all new modules
    - init() is async and calls initializeStorage, migrateToIndexedDB, loadData, checkStorageCapacity
    - All data-modifying functions are async and await their calls
    - No syntax errors
    - App loads in browser
  </verify>
  <done>
    - App initialization is fully async
    - Migration runs on startup
    - Migration errors show toast with retry
    - Storage capacity is checked on startup
    - All data operations properly await async calls
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure ES module script loading</name>
  <files>
    - index.html
  </files>
  <action>
1. Check the existing script tag for app.js in index.html.

2. Ensure it has `type="module"` attribute:
   ```html
   <script type="module" src="js/app.js"></script>
   ```
   (It likely already does since data.js uses exports, but verify)

3. No other script tags should be needed - all modules import their dependencies.
  </action>
  <verify>
    - index.html has `<script type="module" src="js/app.js"></script>`
    - App loads without module errors in browser console
  </verify>
  <done>
    - ES modules load correctly
    - All imports resolve
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 1 infrastructure: IndexedDB migration, storage monitoring, toast notifications, and async app initialization.</what-built>
  <how-to-verify>
1. Open the app in browser (run `npm start` if needed)
2. Open DevTools > Application > IndexedDB
3. Verify 'keyval-store' database exists with 'lagomstronk_data' key
4. Check localStorage still has 'lagomstronk_backup' (preserved as backup)
5. In DevTools Console, run:
   ```javascript
   import('./core/storageMonitor.js').then(m => m.checkStorageCapacity().then(console.log))
   ```
   Should print storage stats
6. Test toast: In console run:
   ```javascript
   import('./ui/toast.js').then(m => m.showToast('Test notification', 'warning'))
   ```
   Should see toast appear in top-right, auto-dismiss after 5 seconds
7. Verify existing workouts (if any) are still visible in app
8. Add a new exercise, verify it saves (check IndexedDB in DevTools)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. App loads without errors
2. Migration runs (check IndexedDB in DevTools)
3. Storage capacity check runs (may not emit warning unless actually near limits)
4. Toast system works (manual test)
5. Data persistence works (add exercise, refresh, verify it's saved)
6. localStorage backup exists
</verification>

<success_criteria>
- App initializes with async storage and migration
- IndexedDB contains migrated workout data
- localStorage backup preserved
- Storage capacity monitoring active
- Toast notifications work for warnings/errors
- All existing app functionality preserved
- Migration errors show retry option
</success_criteria>

<output>
After completion, create `.planning/phases/01-technical-foundation/01-04-SUMMARY.md`
</output>
