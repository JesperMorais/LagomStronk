---
phase: 01-technical-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - js/core/storageMonitor.js
  - js/ui/toast.js
  - css/toast.css
  - index.html
autonomous: true

must_haves:
  truths:
    - "Storage capacity can be checked using Storage Quota API"
    - "70% capacity triggers warning event (once per session)"
    - "90% capacity triggers critical event (once per session)"
    - "Toast notifications display with accessible markup"
    - "Toasts auto-dismiss and can be manually dismissed"
  artifacts:
    - path: "js/core/storageMonitor.js"
      provides: "Storage capacity monitoring"
      exports: ["checkStorageCapacity", "resetSessionWarnings"]
    - path: "js/ui/toast.js"
      provides: "Toast notification system"
      exports: ["showToast", "showStorageWarning", "showStorageCritical"]
    - path: "css/toast.css"
      provides: "Toast styling"
      contains: ".toast-container"
  key_links:
    - from: "js/core/storageMonitor.js"
      to: "js/core/eventBus.js"
      via: "emits storage warning/critical events"
      pattern: "eventBus\\.emit\\(EVENTS\\.STORAGE"
    - from: "js/ui/toast.js"
      to: "js/core/eventBus.js"
      via: "subscribes to storage events"
      pattern: "eventBus\\.on\\(EVENTS\\.STORAGE"
---

<objective>
Implement storage capacity monitoring and toast notification UI for storage warnings.

Purpose: This fulfills FNDN-02 (storage usage monitoring with warning at 70% capacity). The monitor checks capacity using Storage Quota API and emits events. The toast system displays warnings with accessible, dismissible UI.

Output: Storage monitor module and toast notification system.
</objective>

<execution_context>
@/home/david/.claude/get-shit-done/workflows/execute-plan.md
@/home/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/01-technical-foundation/01-CONTEXT.md
@.planning/phases/01-technical-foundation/01-RESEARCH.md
@.planning/phases/01-technical-foundation/01-01-SUMMARY.md
@js/core/eventBus.js
@css/style.css
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage capacity monitor</name>
  <files>
    - js/core/storageMonitor.js
  </files>
  <action>
1. Create `js/core/storageMonitor.js`:

2. Import:
   ```javascript
   import { eventBus, EVENTS } from './eventBus.js';
   ```

3. Define constants:
   ```javascript
   const WARNING_THRESHOLD = 0.70;  // 70%
   const CRITICAL_THRESHOLD = 0.90; // 90%
   ```

4. Module-level state for session tracking:
   ```javascript
   let warningShownThisSession = false;
   let criticalShownThisSession = false;
   ```

5. Implement `checkStorageCapacity()`:
   ```javascript
   export async function checkStorageCapacity() {
     // Check for Storage Quota API support
     if (!navigator.storage || !navigator.storage.estimate) {
       console.warn('Storage Quota API not supported');
       return null;
     }

     try {
       const estimate = await navigator.storage.estimate();
       const usage = estimate.usage || 0;
       const quota = estimate.quota || 0;
       const percentUsed = quota > 0 ? usage / quota : 0;

       // Emit critical event if threshold exceeded (check critical first)
       if (percentUsed >= CRITICAL_THRESHOLD && !criticalShownThisSession) {
         criticalShownThisSession = true;
         eventBus.emit(EVENTS.STORAGE_CRITICAL, {
           usage,
           quota,
           percentUsed: Math.round(percentUsed * 100)
         });
       }
       // Emit warning event if threshold exceeded
       else if (percentUsed >= WARNING_THRESHOLD && !warningShownThisSession) {
         warningShownThisSession = true;
         eventBus.emit(EVENTS.STORAGE_WARNING, {
           usage,
           quota,
           percentUsed: Math.round(percentUsed * 100)
         });
       }

       return {
         usage,
         quota,
         percentUsed: Math.round(percentUsed * 100),
         usageMB: (usage / 1024 / 1024).toFixed(2),
         quotaMB: (quota / 1024 / 1024).toFixed(2)
       };
     } catch (error) {
       console.error('Error checking storage capacity:', error);
       return null;
     }
   }
   ```

6. Implement `resetSessionWarnings()`:
   ```javascript
   export function resetSessionWarnings() {
     warningShownThisSession = false;
     criticalShownThisSession = false;
   }
   ```

7. Export: `checkStorageCapacity`, `resetSessionWarnings`

Reference Pattern 3 in 01-RESEARCH.md.
  </action>
  <verify>
    - `js/core/storageMonitor.js` exists
    - Exports checkStorageCapacity and resetSessionWarnings
    - No syntax errors
  </verify>
  <done>
    - Monitor checks storage using Storage Quota API
    - Emits STORAGE_WARNING at 70%, STORAGE_CRITICAL at 90%
    - Each event fires only once per session
  </done>
</task>

<task type="auto">
  <name>Task 2: Create toast notification system</name>
  <files>
    - js/ui/toast.js
    - css/toast.css
    - index.html
  </files>
  <action>
1. Create `js/ui/` directory if it doesn't exist.

2. Create `css/toast.css`:
   ```css
   /* Toast Container */
   #toast-container {
     position: fixed;
     top: 16px;
     right: 16px;
     z-index: 10000;
     display: flex;
     flex-direction: column;
     gap: 8px;
     pointer-events: none;
   }

   /* Toast Base */
   .toast {
     min-width: 280px;
     max-width: 400px;
     padding: 12px 16px;
     border-radius: 8px;
     background: var(--card-background, #1e1e1e);
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
     display: flex;
     align-items: flex-start;
     gap: 12px;
     pointer-events: auto;
     animation: toast-in 0.3s ease-out;
   }

   .toast-exit {
     animation: toast-out 0.3s ease-in forwards;
   }

   @keyframes toast-in {
     from {
       opacity: 0;
       transform: translateX(100%);
     }
     to {
       opacity: 1;
       transform: translateX(0);
     }
   }

   @keyframes toast-out {
     from {
       opacity: 1;
       transform: translateX(0);
     }
     to {
       opacity: 0;
       transform: translateX(100%);
     }
   }

   /* Toast Types */
   .toast-warning {
     border-left: 4px solid #f59e0b;
   }

   .toast-error {
     border-left: 4px solid #ef4444;
     background: rgba(239, 68, 68, 0.1);
   }

   .toast-info {
     border-left: 4px solid #3b82f6;
   }

   .toast-success {
     border-left: 4px solid #10b981;
   }

   /* Toast Content */
   .toast-content {
     flex: 1;
     color: var(--text-primary, #ffffff);
     font-size: 14px;
     line-height: 1.4;
   }

   .toast-content strong {
     display: block;
     margin-bottom: 4px;
   }

   /* Toast Dismiss Button */
   .toast-dismiss {
     background: none;
     border: none;
     color: var(--text-secondary, #888);
     font-size: 18px;
     cursor: pointer;
     padding: 0;
     line-height: 1;
     opacity: 0.7;
     transition: opacity 0.2s;
   }

   .toast-dismiss:hover {
     opacity: 1;
   }

   .toast-dismiss:focus {
     outline: 2px solid var(--primary-color, #3b82f6);
     outline-offset: 2px;
   }

   /* Mobile Responsiveness */
   @media (max-width: 480px) {
     #toast-container {
       left: 16px;
       right: 16px;
     }

     .toast {
       min-width: auto;
       max-width: none;
     }
   }
   ```

3. Create `js/ui/toast.js`:
   ```javascript
   import { eventBus, EVENTS } from '../core/eventBus.js';

   /**
    * Show a toast notification
    * @param {string} message - Toast content (can include HTML)
    * @param {string} type - 'info' | 'success' | 'warning' | 'error'
    * @param {object} options - { duration, dismissible }
    */
   export function showToast(message, type = 'info', options = {}) {
     const {
       duration = 5000,
       dismissible = true
     } = options;

     const container = getOrCreateContainer();

     const toast = document.createElement('div');
     toast.className = `toast toast-${type}`;
     toast.setAttribute('role', type === 'error' ? 'alert' : 'status');
     toast.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');

     toast.innerHTML = `
       <div class="toast-content">${message}</div>
       ${dismissible ? '<button class="toast-dismiss" aria-label="Dismiss notification">&times;</button>' : ''}
     `;

     container.appendChild(toast);

     // Auto dismiss
     let timeoutId = null;
     if (duration > 0) {
       timeoutId = setTimeout(() => removeToast(toast), duration);
     }

     // Manual dismiss
     if (dismissible) {
       const dismissBtn = toast.querySelector('.toast-dismiss');
       dismissBtn.addEventListener('click', () => {
         if (timeoutId) clearTimeout(timeoutId);
         removeToast(toast);
       });
     }

     return toast;
   }

   function removeToast(toast) {
     toast.classList.add('toast-exit');
     setTimeout(() => {
       if (toast.parentNode) {
         toast.remove();
       }
     }, 300); // Match CSS animation duration
   }

   function getOrCreateContainer() {
     let container = document.getElementById('toast-container');
     if (!container) {
       container = document.createElement('div');
       container.id = 'toast-container';
       document.body.appendChild(container);
     }
     return container;
   }

   /**
    * Show storage warning toast (70% capacity)
    */
   export function showStorageWarning(percentUsed) {
     showToast(
       `<strong>Storage Getting Full</strong>
        You're using ${percentUsed}% of available storage. Consider exporting old workouts to free up space.`,
       'warning',
       { duration: 8000 }
     );
   }

   /**
    * Show storage critical toast (90% capacity)
    */
   export function showStorageCritical(percentUsed) {
     showToast(
       `<strong>Storage Almost Full!</strong>
        You're using ${percentUsed}% of available storage. Export and delete old workouts to prevent data loss.`,
       'error',
       { duration: 0, dismissible: true } // Duration 0 = stays until dismissed
     );
   }

   /**
    * Show migration error toast with retry
    */
   export function showMigrationError(error, onRetry) {
     const toast = showToast(
       `<strong>Data Migration Failed</strong>
        ${error || 'Unknown error'}.
        <button id="retry-migration-btn" style="margin-top:8px;padding:4px 12px;background:var(--primary-color);border:none;border-radius:4px;color:white;cursor:pointer;">Retry</button>`,
       'error',
       { duration: 0, dismissible: true }
     );

     // Attach retry handler
     const retryBtn = toast.querySelector('#retry-migration-btn');
     if (retryBtn && onRetry) {
       retryBtn.addEventListener('click', () => {
         removeToast(toast);
         onRetry();
       });
     }
   }

   // Subscribe to storage events
   eventBus.on(EVENTS.STORAGE_WARNING, ({ detail }) => {
     showStorageWarning(detail.percentUsed);
   });

   eventBus.on(EVENTS.STORAGE_CRITICAL, ({ detail }) => {
     showStorageCritical(detail.percentUsed);
   });
   ```

4. Update `index.html`:
   - Add link to toast.css in the `<head>` section, after the existing style.css link:
     ```html
     <link rel="stylesheet" href="css/toast.css">
     ```

   - The toast container is created dynamically by JavaScript, so no HTML changes needed for that.
  </action>
  <verify>
    - `css/toast.css` exists with toast styling
    - `js/ui/toast.js` exists with showToast, showStorageWarning, showStorageCritical exports
    - `index.html` includes toast.css link
    - Toast subscribes to STORAGE_WARNING and STORAGE_CRITICAL events
  </verify>
  <done>
    - Toast CSS provides accessible, animated notifications
    - Toast JS creates notifications with auto-dismiss and manual dismiss
    - Storage warning/critical events automatically trigger appropriate toasts
    - Migration error toast includes retry button
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `js/core/storageMonitor.js` exists with checkStorageCapacity export
2. `js/ui/toast.js` exists with showToast export
3. `css/toast.css` exists with toast styles
4. `index.html` includes toast.css
5. Manual test: In browser, import toast.js and call showToast('Test', 'warning')
</verification>

<success_criteria>
- Storage monitor checks capacity and emits events at 70%/90% thresholds
- Events fire only once per session (warningShownThisSession flag)
- Toast system displays accessible notifications with ARIA attributes
- Toasts animate in/out, auto-dismiss (configurable), manual dismiss
- Storage events automatically trigger appropriate toast styles
</success_criteria>

<output>
After completion, create `.planning/phases/01-technical-foundation/01-03-SUMMARY.md`
</output>
