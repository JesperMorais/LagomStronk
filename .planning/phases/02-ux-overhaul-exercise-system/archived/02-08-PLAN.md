---
phase: 02-ux-overhaul-exercise-system
plan: 08
type: execute
wave: 3
depends_on: ["02-01", "02-07"]
files_modified:
  - js/ui/components/exerciseWizard.js
  - css/wizard.css
  - js/app.js
  - index.html
autonomous: false

must_haves:
  truths:
    - "User can create custom exercises with guided wizard flow"
    - "User selects muscle groups (primary and secondary)"
    - "User selects equipment type"
    - "Custom exercises have subtle user icon indicator"
  artifacts:
    - path: "js/ui/components/exerciseWizard.js"
      provides: "Guided custom exercise creation wizard"
      exports: ["ExerciseWizard", "openExerciseWizard"]
    - path: "css/wizard.css"
      provides: "Wizard step styling"
  key_links:
    - from: "js/ui/components/exerciseWizard.js"
      to: "js/data.js"
      via: "addCustomExercise call"
      pattern: "addCustomExercise"
---

<objective>
Create guided wizard flow for custom exercise creation with name, muscle group, and equipment selection steps.

Purpose: Implements EXER-04 (custom exercise creation with metadata). Provides a user-friendly way to add custom exercises with proper categorization for filtering.

Output: Exercise wizard component, wizard CSS, integration with existing custom exercise button.
</objective>

<execution_context>
@/home/david/.claude/get-shit-done/workflows/execute-plan.md
@/home/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ux-overhaul-exercise-system/02-CONTEXT.md
@.planning/phases/02-ux-overhaul-exercise-system/02-01-SUMMARY.md
@.planning/phases/02-ux-overhaul-exercise-system/02-07-SUMMARY.md
@js/app.js
@js/data/exercises.js
@/home/david/Dev/personal/color-palette.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create exercise wizard component</name>
  <files>js/ui/components/exerciseWizard.js</files>
  <action>
Create `js/ui/components/exerciseWizard.js` with a multi-step wizard:

```javascript
import { MUSCLE_GROUPS, EQUIPMENT_TYPES } from '../../data/exercises.js';
import { addCustomExercise } from '../../data.js';

export class ExerciseWizard {
  constructor(options = {}) {
    this.onComplete = options.onComplete || (() => {});
    this.onCancel = options.onCancel || (() => {});
    this.currentStep = 1;
    this.totalSteps = 3;
    this.data = {
      name: '',
      primaryMuscles: [],
      secondaryMuscles: [],
      equipment: ''
    };
    this.element = null;

    this.render();
  }

  render() {
    const html = `
      <div class="wizard-modal" id="exercise-wizard">
        <div class="wizard-content">
          <div class="wizard-header">
            <h3>Create Exercise</h3>
            <button class="wizard-close" id="wizard-close">Ã—</button>
          </div>

          <div class="wizard-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${(this.currentStep / this.totalSteps) * 100}%"></div>
            </div>
            <span class="progress-text">Step ${this.currentStep} of ${this.totalSteps}</span>
          </div>

          <div class="wizard-body" id="wizard-body">
            <!-- Step content rendered here -->
          </div>

          <div class="wizard-footer">
            <button class="btn btn-secondary" id="wizard-back" ${this.currentStep === 1 ? 'disabled' : ''}>
              Back
            </button>
            <button class="btn btn-primary" id="wizard-next">
              ${this.currentStep === this.totalSteps ? 'Create Exercise' : 'Next'}
            </button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', html);
    this.element = document.getElementById('exercise-wizard');
    this.attachEvents();
    this.renderStep();
  }

  attachEvents() {
    document.getElementById('wizard-close').addEventListener('click', () => this.close());
    document.getElementById('wizard-back').addEventListener('click', () => this.prevStep());
    document.getElementById('wizard-next').addEventListener('click', () => this.nextStep());

    // Close on overlay click
    this.element.addEventListener('click', (e) => {
      if (e.target === this.element) this.close();
    });
  }

  renderStep() {
    const body = document.getElementById('wizard-body');

    switch (this.currentStep) {
      case 1:
        body.innerHTML = this.renderNameStep();
        break;
      case 2:
        body.innerHTML = this.renderMuscleStep();
        break;
      case 3:
        body.innerHTML = this.renderEquipmentStep();
        break;
    }

    this.attachStepEvents();
    this.updateNavigation();
  }

  renderNameStep() {
    return `
      <div class="wizard-step">
        <h4>What's the exercise called?</h4>
        <p class="step-hint">Enter a descriptive name for your exercise</p>
        <input type="text" class="wizard-input" id="exercise-name-input"
               placeholder="e.g., Cable Flyes" value="${this.data.name}" autofocus>
        <div class="wizard-validation" id="name-validation"></div>
      </div>
    `;
  }

  renderMuscleStep() {
    const primaryChips = Object.keys(MUSCLE_GROUPS).map(group => {
      const isSelected = this.data.primaryMuscles.includes(group);
      return `<button class="wizard-chip ${isSelected ? 'selected' : ''}"
                      data-type="primary" data-value="${group}">${group}</button>`;
    }).join('');

    const secondaryChips = Object.keys(MUSCLE_GROUPS).map(group => {
      const isSelected = this.data.secondaryMuscles.includes(group);
      const isPrimary = this.data.primaryMuscles.includes(group);
      return `<button class="wizard-chip ${isSelected ? 'selected' : ''} ${isPrimary ? 'disabled' : ''}"
                      data-type="secondary" data-value="${group}"
                      ${isPrimary ? 'disabled' : ''}>${group}</button>`;
    }).join('');

    return `
      <div class="wizard-step">
        <h4>Which muscles does it target?</h4>

        <div class="muscle-section">
          <label>Primary Muscles <span class="required">*</span></label>
          <p class="step-hint">Select the main muscle group(s) worked</p>
          <div class="wizard-chips" id="primary-chips">
            ${primaryChips}
          </div>
        </div>

        <div class="muscle-section">
          <label>Secondary Muscles</label>
          <p class="step-hint">Optional: supporting muscles</p>
          <div class="wizard-chips" id="secondary-chips">
            ${secondaryChips}
          </div>
        </div>
      </div>
    `;
  }

  renderEquipmentStep() {
    const equipmentChips = EQUIPMENT_TYPES.map(type => {
      const isSelected = this.data.equipment === type;
      return `<button class="wizard-chip ${isSelected ? 'selected' : ''}"
                      data-type="equipment" data-value="${type}">${type}</button>`;
    }).join('');

    return `
      <div class="wizard-step">
        <h4>What equipment is needed?</h4>
        <p class="step-hint">Select the primary equipment type</p>
        <div class="wizard-chips single-select" id="equipment-chips">
          ${equipmentChips}
        </div>

        <div class="wizard-summary">
          <h4>Summary</h4>
          <div class="summary-item">
            <span class="summary-label">Name:</span>
            <span class="summary-value">${this.data.name}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Primary:</span>
            <span class="summary-value">${this.data.primaryMuscles.join(', ') || 'None selected'}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Secondary:</span>
            <span class="summary-value">${this.data.secondaryMuscles.join(', ') || 'None'}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Equipment:</span>
            <span class="summary-value">${this.data.equipment || 'None selected'}</span>
          </div>
        </div>
      </div>
    `;
  }

  attachStepEvents() {
    // Name input
    const nameInput = document.getElementById('exercise-name-input');
    if (nameInput) {
      nameInput.addEventListener('input', (e) => {
        this.data.name = e.target.value.trim();
        this.validateName();
      });
    }

    // Muscle chips
    document.querySelectorAll('#primary-chips .wizard-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const value = chip.dataset.value;
        if (this.data.primaryMuscles.includes(value)) {
          this.data.primaryMuscles = this.data.primaryMuscles.filter(m => m !== value);
        } else {
          this.data.primaryMuscles.push(value);
        }
        this.renderStep(); // Re-render to update secondary chips disabled state
      });
    });

    document.querySelectorAll('#secondary-chips .wizard-chip:not(.disabled)').forEach(chip => {
      chip.addEventListener('click', () => {
        const value = chip.dataset.value;
        if (this.data.secondaryMuscles.includes(value)) {
          this.data.secondaryMuscles = this.data.secondaryMuscles.filter(m => m !== value);
          chip.classList.remove('selected');
        } else {
          this.data.secondaryMuscles.push(value);
          chip.classList.add('selected');
        }
      });
    });

    // Equipment chips (single select)
    document.querySelectorAll('#equipment-chips .wizard-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        this.data.equipment = chip.dataset.value;
        document.querySelectorAll('#equipment-chips .wizard-chip').forEach(c => c.classList.remove('selected'));
        chip.classList.add('selected');
        // Re-render to update summary
        this.renderStep();
      });
    });
  }

  validateName() {
    const validation = document.getElementById('name-validation');
    if (!this.data.name) {
      validation.textContent = 'Name is required';
      validation.classList.add('error');
      return false;
    }
    if (this.data.name.length < 2) {
      validation.textContent = 'Name must be at least 2 characters';
      validation.classList.add('error');
      return false;
    }
    validation.textContent = '';
    validation.classList.remove('error');
    return true;
  }

  canProceed() {
    switch (this.currentStep) {
      case 1:
        return this.data.name.length >= 2;
      case 2:
        return this.data.primaryMuscles.length > 0;
      case 3:
        return this.data.equipment !== '';
      default:
        return false;
    }
  }

  updateNavigation() {
    const backBtn = document.getElementById('wizard-back');
    const nextBtn = document.getElementById('wizard-next');
    const progress = this.element.querySelector('.progress-fill');
    const progressText = this.element.querySelector('.progress-text');

    backBtn.disabled = this.currentStep === 1;
    nextBtn.disabled = !this.canProceed();
    nextBtn.textContent = this.currentStep === this.totalSteps ? 'Create Exercise' : 'Next';

    progress.style.width = `${(this.currentStep / this.totalSteps) * 100}%`;
    progressText.textContent = `Step ${this.currentStep} of ${this.totalSteps}`;
  }

  prevStep() {
    if (this.currentStep > 1) {
      this.currentStep--;
      this.renderStep();
    }
  }

  async nextStep() {
    if (!this.canProceed()) return;

    if (this.currentStep < this.totalSteps) {
      this.currentStep++;
      this.renderStep();
    } else {
      // Final step - create exercise
      await this.createExercise();
    }
  }

  async createExercise() {
    const metadata = {
      primaryMuscles: this.data.primaryMuscles,
      secondaryMuscles: this.data.secondaryMuscles,
      equipment: this.data.equipment
    };

    try {
      await this.onComplete(this.data.name, metadata);
      this.close();
    } catch (error) {
      console.error('Failed to create exercise:', error);
      alert('Failed to create exercise. Please try again.');
    }
  }

  open() {
    this.element.classList.add('active');
    document.body.style.overflow = 'hidden';
    // Focus first input
    setTimeout(() => {
      document.getElementById('exercise-name-input')?.focus();
    }, 100);
  }

  close() {
    this.element.classList.remove('active');
    document.body.style.overflow = '';
    this.onCancel();
    // Reset state
    this.currentStep = 1;
    this.data = { name: '', primaryMuscles: [], secondaryMuscles: [], equipment: '' };
  }

  destroy() {
    this.element?.remove();
  }
}

// Singleton and convenience
let wizard = null;

export function openExerciseWizard(options = {}) {
  if (wizard) wizard.destroy();
  wizard = new ExerciseWizard(options);
  wizard.open();
  return wizard;
}

export function closeExerciseWizard() {
  wizard?.close();
}
```
  </action>
  <verify>
File exists. In browser console:
`import('./js/ui/components/exerciseWizard.js').then(m => m.openExerciseWizard({ onComplete: console.log }))`
  </verify>
  <done>
- 3-step wizard: Name -> Muscles -> Equipment
- Progress bar shows current step
- Back/Next navigation
- Chip selection for muscles (multi) and equipment (single)
- Summary shown on final step
- Create Exercise button calls onComplete with data
  </done>
</task>

<task type="auto">
  <name>Task 2: Create wizard CSS</name>
  <files>css/wizard.css, index.html</files>
  <action>
**1. Create css/wizard.css:**

```css
/* Exercise Wizard Modal */
.wizard-modal {
  position: fixed;
  inset: 0;
  z-index: 1000;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(4px);
  display: flex;
  justify-content: center;
  align-items: flex-end;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.wizard-modal.active {
  opacity: 1;
  visibility: visible;
}

.wizard-content {
  background: var(--card-background);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  width: 100%;
  max-width: 480px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.wizard-modal.active .wizard-content {
  transform: translateY(0);
}

@media (min-width: 481px) {
  .wizard-modal {
    align-items: center;
  }

  .wizard-content {
    border-radius: var(--radius-lg);
    max-height: 80vh;
  }
}

.wizard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-md);
  border-bottom: 1px solid var(--border-color);
}

.wizard-header h3 {
  font-size: 1.125rem;
  color: var(--mint);
}

.wizard-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--text-secondary);
  cursor: pointer;
  padding: var(--spacing-xs);
}

/* Progress Bar */
.wizard-progress {
  padding: var(--spacing-md);
  padding-bottom: 0;
}

.progress-bar {
  height: 4px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 2px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--mint), var(--mint-dark));
  border-radius: 2px;
  transition: width 0.3s ease;
}

.progress-text {
  display: block;
  text-align: center;
  font-size: 0.75rem;
  color: var(--text-tertiary);
  margin-top: var(--spacing-xs);
}

/* Wizard Body */
.wizard-body {
  flex: 1;
  overflow-y: auto;
  padding: var(--spacing-md);
}

.wizard-step h4 {
  font-size: 1.125rem;
  color: var(--text-primary);
  margin-bottom: var(--spacing-xs);
}

.step-hint {
  font-size: 0.875rem;
  color: var(--text-tertiary);
  margin-bottom: var(--spacing-md);
}

/* Name Input */
.wizard-input {
  width: 100%;
  padding: var(--spacing-md);
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-size: 1.125rem;
}

.wizard-input:focus {
  outline: none;
  border-color: var(--mint);
}

.wizard-validation {
  font-size: 0.75rem;
  color: var(--text-tertiary);
  margin-top: var(--spacing-xs);
  min-height: 1.25em;
}

.wizard-validation.error {
  color: var(--danger-color);
}

/* Muscle Sections */
.muscle-section {
  margin-bottom: var(--spacing-lg);
}

.muscle-section label {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text-secondary);
  display: block;
  margin-bottom: var(--spacing-xs);
}

.muscle-section .required {
  color: var(--danger-color);
}

/* Wizard Chips */
.wizard-chips {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-xs);
}

.wizard-chip {
  padding: var(--spacing-xs) var(--spacing-sm);
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  color: var(--text-secondary);
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.2s;
}

.wizard-chip:hover:not(.disabled) {
  border-color: var(--border-mint);
}

.wizard-chip.selected {
  background: rgba(209, 255, 198, 0.2);
  border-color: var(--mint);
  color: var(--mint);
}

.wizard-chip.disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* Summary */
.wizard-summary {
  margin-top: var(--spacing-lg);
  padding: var(--spacing-md);
  background: rgba(255, 255, 255, 0.03);
  border-radius: var(--radius);
}

.wizard-summary h4 {
  font-size: 0.875rem;
  color: var(--text-secondary);
  margin-bottom: var(--spacing-sm);
}

.summary-item {
  display: flex;
  gap: var(--spacing-sm);
  padding: var(--spacing-xs) 0;
  border-bottom: 1px solid var(--border-color);
}

.summary-item:last-child {
  border-bottom: none;
}

.summary-label {
  font-size: 0.875rem;
  color: var(--text-tertiary);
  min-width: 80px;
}

.summary-value {
  font-size: 0.875rem;
  color: var(--text-primary);
}

/* Wizard Footer */
.wizard-footer {
  display: flex;
  gap: var(--spacing-sm);
  padding: var(--spacing-md);
  border-top: 1px solid var(--border-color);
}

.wizard-footer .btn {
  flex: 1;
}

.wizard-footer .btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
```

**2. Update index.html:**
```html
<link rel="stylesheet" href="css/wizard.css">
```
  </action>
  <verify>
- css/wizard.css exists
- index.html includes wizard.css link
  </verify>
  <done>
- Modal slides up from bottom (mobile) or centers (desktop)
- Progress bar shows completion
- Chips for muscle/equipment selection
- Summary section on final step
- Validation styling
- Responsive layout
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate wizard with app</name>
  <files>js/app.js</files>
  <action>
**Update js/app.js to use wizard instead of simple modal:**

Add import:
```javascript
import { openExerciseWizard } from './ui/components/exerciseWizard.js';
```

Update the custom exercise button handler:
```javascript
// Replace the existing openCustomExerciseModal call
document.getElementById('add-custom-exercise-btn').addEventListener('click', () => {
  openExerciseWizard({
    onComplete: async (name, metadata) => {
      appData = await addCustomExercise(appData, name, metadata);
      renderLibraryView();
    },
    onCancel: () => {
      // Nothing to do
    }
  });
});
```

**Remove or keep the old simple modal for backward compatibility:**

Option A: Remove the old custom-exercise-modal entirely from HTML and JS (cleaner)

Option B: Keep both, wizard is the new default (safer for rollback)

**Recommend Option A** - remove old modal code since wizard replaces it completely.

In index.html, remove the `#custom-exercise-modal` element.

In setupEventListeners, remove the old custom modal event listeners:
```javascript
// Remove these:
// document.getElementById('add-custom-exercise-btn').addEventListener('click', openCustomExerciseModal);
// document.getElementById('close-custom-modal').addEventListener('click', closeCustomExerciseModal);
// document.getElementById('cancel-custom').addEventListener('click', closeCustomExerciseModal);
// document.getElementById('save-custom').addEventListener('click', saveCustomExercise);
```

Remove the old functions:
```javascript
// Remove: openCustomExerciseModal, closeCustomExerciseModal, saveCustomExercise
```
  </action>
  <verify>
1. Open app, go to Library view
2. Click "+ Add Custom Exercise" button
3. Wizard should open instead of simple modal
4. Complete all 3 steps with valid data
5. Exercise appears in library with custom badge
6. Exercise can be filtered by selected muscle group
  </verify>
  <done>
- Add Custom Exercise button opens wizard
- Wizard completes successfully
- New exercise appears in library
- New exercise has custom indicator
- New exercise has correct metadata for filtering
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2 UX Overhaul and Exercise System - all 8 plans</what-built>
  <how-to-verify>
1. Start the app: `npm start` and open http://localhost:3000

2. **Dashboard (Today view)**
   - See hero section with streak display (flame + number + 7-day calendar)
   - See volume chart with gradient bars
   - See recent PRs as horizontal scrollable cards
   - See mint FAB at bottom right

3. **Workout Logging**
   - Tap FAB or Add Exercise
   - Verify custom numpad appears when tapping number inputs
   - Verify numpad matches design (1-9, 0, ., +/-, backspace, NEXT)
   - Complete a set - verify checkmark animation and confetti
   - Navigate away - verify mini-player shows at bottom
   - Tap mini-player - returns to workout

4. **History (Calendar)**
   - Toggle between calendar and list view
   - See intensity markers on workout days
   - Tap a workout day - see popup summary

5. **Exercise Library**
   - Search filters exercises in real-time
   - Filter button opens drawer with muscle/equipment chips
   - Toggle between list and grid view
   - Recently used exercises show at top
   - Tap star to favorite
   - Add Custom Exercise opens wizard
   - Complete wizard - exercise appears with metadata

6. **Overall**
   - No console errors
   - Colors match mint/dark theme
   - Responsive on mobile viewport
  </how-to-verify>
  <resume-signal>Type "approved" if everything works, or describe specific issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Wizard opens from Library view button
2. Step 1: Can enter exercise name, validation works
3. Step 2: Can select primary muscles (required), secondary optional
4. Step 3: Can select equipment, summary shows all data
5. Create: Exercise added to library with metadata
6. Filter: New exercise appears when filtering by its muscle group
7. Custom badge: New exercise shows user icon indicator
</verification>

<success_criteria>
- Wizard has 3 steps: Name -> Muscles -> Equipment
- Progress bar updates on each step
- Back button returns to previous step
- Next button disabled until step is valid
- Primary muscles required, secondary optional
- Equipment required
- Summary shows all selections before creating
- Created exercise has proper metadata
- Created exercise appears in library with custom indicator
</success_criteria>

<output>
After completion, create `.planning/phases/02-ux-overhaul-exercise-system/02-08-SUMMARY.md`
</output>
