---
phase: 02-ux-overhaul-exercise-system
plan: 06
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - js/ui/components/calendar.js
  - css/calendar.css
  - js/app.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "User can view workout history in calendar format"
    - "User sees intensity gradient markers on workout days"
    - "User can tap a day to see workout summary"
    - "Calendar shows hybrid month/week view"
  artifacts:
    - path: "js/ui/components/calendar.js"
      provides: "Workout history calendar component"
      exports: ["WorkoutCalendar", "renderCalendar"]
    - path: "css/calendar.css"
      provides: "Calendar styling with intensity gradients"
  key_links:
    - from: "js/ui/components/calendar.js"
      to: "js/data.js"
      via: "import for workout data"
      pattern: "getWorkoutByDate|getWorkoutsSorted"
---

<objective>
Create workout history calendar with hybrid month/week view and intensity gradient markers.

Purpose: Implements UX-09 (calendar view of workout history). Provides visual overview of training consistency and intensity over time.

Output: Calendar component with month grid, intensity colors, day tap popup.
</objective>

<execution_context>
@/home/david/.claude/get-shit-done/workflows/execute-plan.md
@/home/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ux-overhaul-exercise-system/02-CONTEXT.md
@.planning/phases/02-ux-overhaul-exercise-system/02-RESEARCH.md
@.planning/phases/02-ux-overhaul-exercise-system/02-01-SUMMARY.md
@js/app.js
@css/style.css
@/home/david/Dev/personal/color-palette.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create calendar component</name>
  <files>js/ui/components/calendar.js</files>
  <action>
Create `js/ui/components/calendar.js` following RESEARCH.md patterns:

```javascript
import { getWorkoutByDate, formatDate } from '../../data.js';

export class WorkoutCalendar {
  constructor(container, workouts) {
    this.container = container;
    this.workouts = workouts;
    this.currentDate = new Date();
    this.selectedDate = null;
    this.intensityCache = new Map();

    this.render();
  }

  render() {
    this.container.innerHTML = `
      <div class="calendar">
        <div class="calendar-header">
          <button class="calendar-nav prev" id="cal-prev">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
            </svg>
          </button>
          <h3 class="calendar-title" id="cal-title"></h3>
          <button class="calendar-nav next" id="cal-next">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
            </svg>
          </button>
        </div>
        <div class="calendar-weekdays">
          <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
        </div>
        <div class="calendar-grid" id="cal-grid"></div>
        <div class="calendar-popup" id="cal-popup"></div>
      </div>
    `;

    this.attachEvents();
    this.renderMonth();
  }

  attachEvents() {
    document.getElementById('cal-prev').addEventListener('click', () => this.prevMonth());
    document.getElementById('cal-next').addEventListener('click', () => this.nextMonth());

    document.getElementById('cal-grid').addEventListener('click', (e) => {
      const dayEl = e.target.closest('.calendar-day');
      if (dayEl && dayEl.dataset.date) {
        this.selectDay(dayEl.dataset.date);
      }
    });

    // Close popup when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.calendar-day') && !e.target.closest('.calendar-popup')) {
        this.closePopup();
      }
    });
  }

  renderMonth() {
    const year = this.currentDate.getFullYear();
    const month = this.currentDate.getMonth();

    // Update title
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('cal-title').textContent = `${monthNames[month]} ${year}`;

    // Get first day and last day of month
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startPadding = firstDay.getDay(); // 0-6, Sunday = 0

    // Calculate intensities for this month
    const intensities = this.getMonthIntensities(year, month);

    // Build calendar grid
    let html = '';

    // Padding days from previous month
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = startPadding - 1; i >= 0; i--) {
      const day = prevMonthLastDay - i;
      html += `<div class="calendar-day other-month">${day}</div>`;
    }

    // Current month days
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];

    for (let day = 1; day <= lastDay.getDate(); day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const intensity = intensities[dateStr] || 0;
      const isToday = dateStr === todayStr;
      const isSelected = dateStr === this.selectedDate;
      const hasWorkout = intensity > 0;

      const classes = [
        'calendar-day',
        isToday ? 'today' : '',
        isSelected ? 'selected' : '',
        hasWorkout ? 'has-workout' : ''
      ].filter(Boolean).join(' ');

      const style = hasWorkout ? `--intensity: ${intensity}` : '';

      html += `
        <div class="${classes}" data-date="${dateStr}" style="${style}">
          <span class="day-number">${day}</span>
          ${hasWorkout ? '<span class="day-marker"></span>' : ''}
        </div>
      `;
    }

    // Padding days from next month
    const totalCells = startPadding + lastDay.getDate();
    const remainingCells = 7 - (totalCells % 7);
    if (remainingCells < 7) {
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
      }
    }

    document.getElementById('cal-grid').innerHTML = html;
  }

  getMonthIntensities(year, month) {
    const cacheKey = `${year}-${month}`;
    if (this.intensityCache.has(cacheKey)) {
      return this.intensityCache.get(cacheKey);
    }

    const intensities = {};
    const monthStart = new Date(year, month, 1);
    const monthEnd = new Date(year, month + 1, 0);

    // Find max volume for normalization
    let maxVolume = 0;
    const monthWorkouts = this.workouts.filter(w => {
      const d = new Date(w.date);
      return d >= monthStart && d <= monthEnd;
    });

    monthWorkouts.forEach(workout => {
      const volume = this.calculateWorkoutVolume(workout);
      if (volume > maxVolume) maxVolume = volume;
    });

    // Calculate normalized intensities
    monthWorkouts.forEach(workout => {
      const volume = this.calculateWorkoutVolume(workout);
      intensities[workout.date] = maxVolume > 0 ? volume / maxVolume : 0.5;
    });

    this.intensityCache.set(cacheKey, intensities);
    return intensities;
  }

  calculateWorkoutVolume(workout) {
    return workout.exercises.reduce((total, ex) => {
      return total + ex.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
    }, 0);
  }

  prevMonth() {
    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
    this.renderMonth();
    this.closePopup();
  }

  nextMonth() {
    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
    this.renderMonth();
    this.closePopup();
  }

  selectDay(dateStr) {
    this.selectedDate = dateStr;
    this.renderMonth(); // Re-render to update selection

    const workout = getWorkoutByDate({ workouts: this.workouts }, dateStr);
    if (workout) {
      this.showPopup(dateStr, workout);
    } else {
      this.closePopup();
    }
  }

  showPopup(dateStr, workout) {
    const popup = document.getElementById('cal-popup');
    const totalVolume = this.calculateWorkoutVolume(workout);
    const totalSets = workout.exercises.reduce((sum, ex) => sum + ex.sets.length, 0);

    popup.innerHTML = `
      <div class="popup-header">
        <span class="popup-date">${formatDate(dateStr)}</span>
        <button class="popup-close" onclick="this.closest('.calendar-popup').classList.remove('visible')">Ã—</button>
      </div>
      <div class="popup-stats">
        <div class="popup-stat">
          <span class="popup-stat-value">${workout.exercises.length}</span>
          <span class="popup-stat-label">exercises</span>
        </div>
        <div class="popup-stat">
          <span class="popup-stat-value">${totalSets}</span>
          <span class="popup-stat-label">sets</span>
        </div>
        <div class="popup-stat">
          <span class="popup-stat-value">${Math.round(totalVolume / 1000)}k</span>
          <span class="popup-stat-label">kg</span>
        </div>
      </div>
      <div class="popup-exercises">
        ${workout.exercises.map(ex => `<span class="popup-exercise">${ex.name}</span>`).join('')}
      </div>
      <button class="popup-view-btn" onclick="viewWorkout('${dateStr}')">View Details</button>
    `;

    popup.classList.add('visible');
  }

  closePopup() {
    document.getElementById('cal-popup')?.classList.remove('visible');
  }

  updateWorkouts(workouts) {
    this.workouts = workouts;
    this.intensityCache.clear();
    this.renderMonth();
  }
}

// Convenience function for app integration
export function renderCalendar(container, workouts) {
  return new WorkoutCalendar(container, workouts);
}
```
  </action>
  <verify>
File exists. In browser console:
`import('./js/ui/components/calendar.js').then(m => console.log(typeof m.WorkoutCalendar))`
  </verify>
  <done>
- WorkoutCalendar class renders month grid
- Navigation between months works
- Intensity calculated per workout day
- Day tap shows popup with workout summary
- Cache prevents recalculation of same month
  </done>
</task>

<task type="auto">
  <name>Task 2: Create calendar CSS</name>
  <files>css/calendar.css, index.html</files>
  <action>
**1. Create css/calendar.css:**

```css
/* Workout Calendar */
.calendar {
  background: rgba(35, 44, 51, 0.6);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: var(--spacing-md);
  position: relative;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-md);
}

.calendar-title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
}

.calendar-nav {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  padding: var(--spacing-xs);
  border-radius: var(--radius);
  transition: background-color 0.2s;
}

.calendar-nav:hover {
  background: rgba(255, 255, 255, 0.1);
}

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  text-align: center;
  margin-bottom: var(--spacing-sm);
}

.calendar-weekdays span {
  font-size: 0.625rem;
  color: var(--text-tertiary);
  text-transform: uppercase;
  font-weight: 500;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius);
  cursor: pointer;
  position: relative;
  transition: background-color 0.2s;
}

.calendar-day:hover {
  background: rgba(255, 255, 255, 0.05);
}

.calendar-day.other-month {
  opacity: 0.3;
  cursor: default;
}

.calendar-day.today .day-number {
  color: var(--mint);
  font-weight: 600;
}

.calendar-day.selected {
  background: rgba(209, 255, 198, 0.15);
  border: 1px solid var(--border-mint);
}

.day-number {
  font-size: 0.875rem;
  color: var(--text-primary);
}

/* Intensity gradient marker */
.day-marker {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  margin-top: 2px;
  background: var(--mint);
  /* Intensity controls opacity: 0.3 (light) to 1.0 (dark) */
  opacity: calc(0.3 + var(--intensity, 0.5) * 0.7);
}

.calendar-day.has-workout {
  /* Subtle background tint based on intensity */
  background: rgba(209, 255, 198, calc(0.05 + var(--intensity, 0.5) * 0.1));
}

/* Day Popup */
.calendar-popup {
  position: absolute;
  left: 50%;
  bottom: 100%;
  transform: translateX(-50%) translateY(10px);
  background: var(--card-background);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  width: 90%;
  max-width: 280px;
  box-shadow: var(--shadow-lg);
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, transform 0.2s;
  z-index: 10;
}

.calendar-popup.visible {
  opacity: 1;
  visibility: visible;
  transform: translateX(-50%) translateY(-8px);
}

.popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-sm);
}

.popup-date {
  font-weight: 600;
  color: var(--mint);
}

.popup-close {
  background: none;
  border: none;
  color: var(--text-tertiary);
  font-size: 1.25rem;
  cursor: pointer;
  padding: 0;
  line-height: 1;
}

.popup-stats {
  display: flex;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-sm);
}

.popup-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.popup-stat-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-primary);
}

.popup-stat-label {
  font-size: 0.625rem;
  color: var(--text-tertiary);
  text-transform: uppercase;
}

.popup-exercises {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-sm);
}

.popup-exercise {
  font-size: 0.75rem;
  padding: 2px 8px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
  color: var(--text-secondary);
}

.popup-view-btn {
  width: 100%;
  padding: var(--spacing-sm);
  background: var(--mint);
  border: none;
  border-radius: var(--radius);
  color: #0f1419;
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
}

.popup-view-btn:hover {
  background: var(--mint-dark);
}

/* Responsive */
@media (max-width: 360px) {
  .day-number {
    font-size: 0.75rem;
  }

  .day-marker {
    width: 4px;
    height: 4px;
  }
}
```

**2. Update index.html:**
```html
<link rel="stylesheet" href="css/calendar.css">
```
  </action>
  <verify>
- css/calendar.css exists
- index.html includes calendar.css link
  </verify>
  <done>
- Calendar grid displays 7 columns
- Day markers show intensity gradient
- Today highlighted with mint
- Selected day has border
- Popup positions above calendar
- Responsive for small screens
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate calendar into history view</name>
  <files>js/app.js, index.html</files>
  <action>
**1. Update index.html #history-view:**

Replace history view content with calendar + list toggle:

```html
<section id="history-view" class="view">
  <div class="view-header">
    <h2>Workout History</h2>
    <div class="history-view-toggle">
      <button class="toggle-btn active" data-view="calendar" id="history-calendar-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>
        </svg>
      </button>
      <button class="toggle-btn" data-view="list" id="history-list-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
        </svg>
      </button>
    </div>
  </div>
  <div id="history-calendar" class="history-calendar"></div>
  <div id="history-list" class="history-list" style="display: none;"></div>
</section>
```

**2. Update js/app.js:**

Add import:
```javascript
import { renderCalendar } from './ui/components/calendar.js';
```

Add state:
```javascript
let historyCalendar = null;
let historyViewMode = 'calendar'; // 'calendar' or 'list'
```

Update renderHistoryView:
```javascript
function renderHistoryView() {
  const calendarContainer = document.getElementById('history-calendar');
  const listContainer = document.getElementById('history-list');

  if (historyViewMode === 'calendar') {
    calendarContainer.style.display = 'block';
    listContainer.style.display = 'none';

    // Create or update calendar
    if (!historyCalendar) {
      historyCalendar = renderCalendar(calendarContainer, appData.workouts);
    } else {
      historyCalendar.updateWorkouts(appData.workouts);
    }
  } else {
    calendarContainer.style.display = 'none';
    listContainer.style.display = 'block';
    renderHistoryList(); // Existing list rendering
  }
}

function renderHistoryList() {
  const workouts = getWorkoutsSorted(appData);
  const historyListEl = document.getElementById('history-list');

  if (workouts.length === 0) {
    historyListEl.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ðŸ“…</div>
        <p>No workout history yet.</p>
        <p>Start logging workouts to see them here!</p>
      </div>
    `;
    return;
  }

  // ... existing list rendering code ...
}
```

Add toggle handlers in setupEventListeners:
```javascript
document.getElementById('history-calendar-btn')?.addEventListener('click', () => {
  historyViewMode = 'calendar';
  updateHistoryToggle();
  renderHistoryView();
});

document.getElementById('history-list-btn')?.addEventListener('click', () => {
  historyViewMode = 'list';
  updateHistoryToggle();
  renderHistoryView();
});

function updateHistoryToggle() {
  document.getElementById('history-calendar-btn').classList.toggle('active', historyViewMode === 'calendar');
  document.getElementById('history-list-btn').classList.toggle('active', historyViewMode === 'list');
}
```

**3. Add toggle button CSS to calendar.css:**
```css
.history-view-toggle {
  display: flex;
  gap: 4px;
  background: rgba(255, 255, 255, 0.05);
  padding: 4px;
  border-radius: var(--radius);
}

.toggle-btn {
  background: transparent;
  border: none;
  padding: var(--spacing-xs);
  border-radius: var(--radius);
  color: var(--text-tertiary);
  cursor: pointer;
  transition: all 0.2s;
}

.toggle-btn.active {
  background: var(--mint);
  color: #0f1419;
}

.toggle-btn:hover:not(.active) {
  background: rgba(255, 255, 255, 0.1);
}

.view-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
```
  </action>
  <verify>
1. Open app, go to History view
2. Calendar should display by default
3. Click list icon - switches to list view
4. Click calendar icon - switches back
5. Click on day with workout - popup shows
6. Click "View Details" - opens workout modal
  </verify>
  <done>
- Calendar view default in history
- Toggle between calendar and list
- Calendar shows workout days with intensity
- Day tap shows popup
- Popup has view details button
  </done>
</task>

</tasks>

<verification>
1. Calendar renders: History view shows month grid
2. Navigation: Can navigate to previous/next month
3. Intensity: Days with workouts show gradient markers
4. Today: Current day highlighted with mint
5. Day tap: Popup appears with workout summary
6. View details: Clicking button opens existing workout modal
7. Toggle: Can switch between calendar and list view
</verification>

<success_criteria>
- Calendar grid renders correctly
- Month navigation works
- Workout days show intensity markers (lighter = less volume, darker = more)
- Day tap shows popup with exercise count, sets, volume
- View Details button opens existing workout modal
- Toggle between calendar and list works
- Cache prevents recalculation on re-render
</success_criteria>

<output>
After completion, create `.planning/phases/02-ux-overhaul-exercise-system/02-06-SUMMARY.md`
</output>
