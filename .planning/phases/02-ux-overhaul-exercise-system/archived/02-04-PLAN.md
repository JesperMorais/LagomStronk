---
phase: 02-ux-overhaul-exercise-system
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - js/ui/components/numpad.js
  - css/numpad.css
  - index.html
autonomous: true

must_haves:
  truths:
    - "User sees custom numpad matching design inspiration"
    - "User can input numbers with 0-9, decimal, backspace"
    - "User can use +/- steppers to adjust values"
    - "User can tap NEXT to advance to next field"
    - "User can toggle to system keyboard"
  artifacts:
    - path: "js/ui/components/numpad.js"
      provides: "Custom numeric keypad component"
      exports: ["Numpad", "initNumpad", "showNumpad", "hideNumpad"]
    - path: "css/numpad.css"
      provides: "Numpad styling matching inspiration"
  key_links:
    - from: "js/ui/components/numpad.js"
      to: "input fields"
      via: "focus event listener"
      pattern: "addEventListener.*focus"
---

<objective>
Create custom numeric keypad matching the design in inspiration/numpad.jpg with +/- steppers, settings, keyboard toggle, and NEXT button.

Purpose: Implements the number input requirement from CONTEXT.md. This numpad will be used for weight/reps input during workout logging, providing a better mobile experience than the system keyboard.

Output: Numpad component, CSS styles, integrated into app.
</objective>

<execution_context>
@/home/david/.claude/get-shit-done/workflows/execute-plan.md
@/home/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ux-overhaul-exercise-system/02-CONTEXT.md
@.planning/phases/02-ux-overhaul-exercise-system/02-RESEARCH.md
@design/numpad.jpg
@/home/david/Dev/personal/color-palette.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create numpad component</name>
  <files>js/ui/components/numpad.js</files>
  <action>
Create `js/ui/components/numpad.js` following the pattern from RESEARCH.md but matching the design in numpad.jpg:

**Numpad layout (from image):**
```
Row 1: [1] [2] [3] [keyboard toggle with down arrow]
Row 2: [4] [5] [6] [- stepper] [+ stepper]
Row 3: [7] [8] [9] [settings icon]
Row 4: [.] [0] [backspace] [NEXT button - blue/mint]
```

**Numpad class:**
```javascript
export class Numpad {
  constructor(options = {}) {
    this.maxDigits = options.maxDigits || 6;
    this.maxDecimals = options.maxDecimals || 1;
    this.step = options.step || 2.5;
    this.onNext = options.onNext || (() => {});
    this.onSettings = options.onSettings || (() => {});
    this.currentInput = null;
    this.value = '';
    this.isVisible = false;
    this.element = null;

    this.render();
    this.attachEvents();
  }

  render() {
    // Create numpad HTML matching numpad.jpg design
    const html = `
      <div class="numpad" id="app-numpad">
        <div class="numpad-grid">
          <!-- Row 1 -->
          <button class="numpad-btn" data-digit="1">1</button>
          <button class="numpad-btn" data-digit="2">2</button>
          <button class="numpad-btn" data-digit="3">3</button>
          <button class="numpad-btn numpad-special" data-action="keyboard">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 5H4c-1.1 0-1.99.9-1.99 2L2 17c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm0-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/>
            </svg>
            <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
          </button>

          <!-- Row 2 -->
          <button class="numpad-btn" data-digit="4">4</button>
          <button class="numpad-btn" data-digit="5">5</button>
          <button class="numpad-btn" data-digit="6">6</button>
          <button class="numpad-btn numpad-stepper" data-action="minus">âˆ’</button>
          <button class="numpad-btn numpad-stepper" data-action="plus">+</button>

          <!-- Row 3 -->
          <button class="numpad-btn" data-digit="7">7</button>
          <button class="numpad-btn" data-digit="8">8</button>
          <button class="numpad-btn" data-digit="9">9</button>
          <button class="numpad-btn numpad-special numpad-settings" data-action="settings">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/>
            </svg>
          </button>

          <!-- Row 4 -->
          <button class="numpad-btn" data-digit=".">.</button>
          <button class="numpad-btn" data-digit="0">0</button>
          <button class="numpad-btn numpad-backspace" data-action="backspace">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M22 3H7c-.69 0-1.23.35-1.59.88L0 12l5.41 8.11c.36.53.9.89 1.59.89h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-3 12.59L17.59 17 14 13.41 10.41 17 9 15.59 12.59 12 9 8.41 10.41 7 14 10.59 17.59 7 19 8.41 15.41 12 19 15.59z"/>
            </svg>
          </button>
          <button class="numpad-btn numpad-next" data-action="next">NEXT</button>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', html);
    this.element = document.getElementById('app-numpad');
  }

  attachEvents() {
    this.element.addEventListener('click', (e) => {
      const btn = e.target.closest('.numpad-btn');
      if (!btn) return;

      const digit = btn.dataset.digit;
      const action = btn.dataset.action;

      if (digit !== undefined) this.addDigit(digit);
      else if (action === 'backspace') this.backspace();
      else if (action === 'plus') this.stepUp();
      else if (action === 'minus') this.stepDown();
      else if (action === 'next') this.next();
      else if (action === 'keyboard') this.toggleKeyboard();
      else if (action === 'settings') this.onSettings();

      // Haptic feedback
      if (navigator.vibrate) navigator.vibrate(10);
    });

    // Prevent numpad from stealing focus
    this.element.addEventListener('mousedown', (e) => e.preventDefault());
  }

  addDigit(digit) {
    if (digit === '.' && this.value.includes('.')) return;
    if (this.value.length >= this.maxDigits) return;

    // Handle decimal places limit
    if (this.value.includes('.')) {
      const decimalPart = this.value.split('.')[1] || '';
      if (decimalPart.length >= this.maxDecimals) return;
    }

    this.value = (this.value === '0' && digit !== '.') ? digit : this.value + digit;
    this.updateDisplay();
  }

  backspace() {
    this.value = this.value.slice(0, -1) || '0';
    this.updateDisplay();
  }

  stepUp() {
    const current = parseFloat(this.value) || 0;
    this.value = (current + this.step).toFixed(1).replace(/\.0$/, '');
    this.updateDisplay();
  }

  stepDown() {
    const current = parseFloat(this.value) || 0;
    const newValue = Math.max(0, current - this.step);
    this.value = newValue.toFixed(1).replace(/\.0$/, '');
    this.updateDisplay();
  }

  updateDisplay() {
    if (this.currentInput) {
      this.currentInput.value = this.value;
      // Dispatch input event for any listeners
      this.currentInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
  }

  show(inputElement, initialValue = '') {
    this.currentInput = inputElement;
    this.value = initialValue || inputElement.value || '0';
    this.element.classList.add('visible');
    this.isVisible = true;
  }

  hide() {
    this.element.classList.remove('visible');
    this.isVisible = false;
    this.currentInput = null;
  }

  next() {
    this.onNext(parseFloat(this.value) || 0, this.currentInput);
  }

  toggleKeyboard() {
    this.hide();
    if (this.currentInput) {
      // Allow system keyboard by removing readonly and focusing
      this.currentInput.removeAttribute('readonly');
      this.currentInput.focus();
    }
  }

  destroy() {
    this.element?.remove();
  }
}

// Module-level singleton and convenience functions
let globalNumpad = null;

export function initNumpad(options = {}) {
  if (globalNumpad) globalNumpad.destroy();
  globalNumpad = new Numpad(options);
  return globalNumpad;
}

export function showNumpad(input, initialValue) {
  globalNumpad?.show(input, initialValue);
}

export function hideNumpad() {
  globalNumpad?.hide();
}

export function getNumpad() {
  return globalNumpad;
}
```
  </action>
  <verify>
File exists. Run `node -e "import('./js/ui/components/numpad.js').then(m => console.log(typeof m.Numpad))"` - should output "function".
  </verify>
  <done>
- Numpad class with all methods
- Layout matches numpad.jpg (4x4 grid with +/- in row 2)
- Digit input, backspace, steppers work
- NEXT button calls callback
- Keyboard toggle hides numpad and focuses input
- Settings button calls callback
  </done>
</task>

<task type="auto">
  <name>Task 2: Create numpad CSS</name>
  <files>css/numpad.css, index.html</files>
  <action>
**1. Create css/numpad.css matching numpad.jpg design:**

```css
/* Numpad - Matches inspiration/numpad.jpg */
.numpad {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #232C33;
  border-top: 1px solid var(--border-color);
  padding: var(--spacing-md);
  padding-bottom: calc(var(--spacing-md) + env(safe-area-inset-bottom));
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1001; /* Above mini-player (100) and below toast (9999) */
}

.numpad.visible {
  transform: translateY(0);
}

.numpad-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--spacing-sm);
  max-width: 400px;
  margin: 0 auto;
}

/* Row 2 has 5 columns (4,5,6,-,+) */
.numpad-grid > .numpad-btn:nth-child(5),
.numpad-grid > .numpad-btn:nth-child(6),
.numpad-grid > .numpad-btn:nth-child(7),
.numpad-grid > .numpad-btn:nth-child(8),
.numpad-grid > .numpad-btn:nth-child(9) {
  /* These are row 2 buttons - need special handling */
}

/* Actually, let's use a different approach with explicit grid areas */
.numpad-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 0.5fr 0.5fr;
  grid-template-rows: repeat(4, 56px);
  gap: var(--spacing-sm);
  max-width: 400px;
  margin: 0 auto;
}

/* Row 1: 1,2,3 span first 3 cols, keyboard spans last 2 */
.numpad-btn:nth-child(1) { grid-column: 1; grid-row: 1; }
.numpad-btn:nth-child(2) { grid-column: 2; grid-row: 1; }
.numpad-btn:nth-child(3) { grid-column: 3; grid-row: 1; }
.numpad-btn:nth-child(4) { grid-column: 4 / 6; grid-row: 1; } /* keyboard */

/* Row 2: 4,5,6,-,+ each get one column */
.numpad-btn:nth-child(5) { grid-column: 1; grid-row: 2; }
.numpad-btn:nth-child(6) { grid-column: 2; grid-row: 2; }
.numpad-btn:nth-child(7) { grid-column: 3; grid-row: 2; }
.numpad-btn:nth-child(8) { grid-column: 4; grid-row: 2; }
.numpad-btn:nth-child(9) { grid-column: 5; grid-row: 2; }

/* Row 3: 7,8,9 span first 3, settings spans last 2 */
.numpad-btn:nth-child(10) { grid-column: 1; grid-row: 3; }
.numpad-btn:nth-child(11) { grid-column: 2; grid-row: 3; }
.numpad-btn:nth-child(12) { grid-column: 3; grid-row: 3; }
.numpad-btn:nth-child(13) { grid-column: 4 / 6; grid-row: 3; } /* settings */

/* Row 4: ., 0, backspace span first 3, NEXT spans last 2 */
.numpad-btn:nth-child(14) { grid-column: 1; grid-row: 4; }
.numpad-btn:nth-child(15) { grid-column: 2; grid-row: 4; }
.numpad-btn:nth-child(16) { grid-column: 3; grid-row: 4; }
.numpad-btn:nth-child(17) { grid-column: 4 / 6; grid-row: 4; } /* NEXT */

.numpad-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  border: none;
  color: var(--text-primary);
  font-size: 1.5rem;
  font-weight: 500;
  cursor: pointer;
  border-radius: var(--radius);
  transition: background-color 0.1s;
  -webkit-tap-highlight-color: transparent;
}

.numpad-btn:active {
  background: rgba(255, 255, 255, 0.1);
}

/* Special buttons (keyboard, settings) */
.numpad-special {
  background: rgba(255, 255, 255, 0.05);
  color: var(--text-secondary);
}

.numpad-special svg {
  width: 24px;
  height: 24px;
}

.numpad-special .chevron {
  width: 16px;
  height: 16px;
  margin-left: 2px;
}

/* Stepper buttons */
.numpad-stepper {
  background: rgba(255, 255, 255, 0.05);
  font-size: 1.75rem;
}

/* Backspace */
.numpad-backspace {
  color: var(--text-secondary);
}

.numpad-backspace svg {
  width: 28px;
  height: 28px;
}

/* NEXT button - blue/mint accent */
.numpad-next {
  background: #4A90D9; /* Blue from the image, or use mint for brand consistency */
  /* Alternative: background: var(--mint); */
  color: white;
  font-size: 1rem;
  font-weight: 600;
  border-radius: var(--radius);
}

.numpad-next:active {
  background: #3a7bc8;
}

/* Settings icon styling */
.numpad-settings svg {
  width: 28px;
  height: 28px;
}

/* Safe area for devices with home indicator */
@supports (padding-bottom: env(safe-area-inset-bottom)) {
  .numpad {
    padding-bottom: calc(var(--spacing-md) + env(safe-area-inset-bottom));
  }
}
```

**2. Update index.html:**
Add stylesheet link after toast.css:
```html
<link rel="stylesheet" href="css/numpad.css">
```

**Important:** The numpad image shows a blue NEXT button. For brand consistency, consider using mint instead. Implement blue first to match image, can be changed via CSS variable later.
  </action>
  <verify>
- css/numpad.css file exists
- index.html includes numpad.css link
- Open app, manually test: `import('./js/ui/components/numpad.js').then(m => { m.initNumpad(); m.showNumpad(document.body) })`
  </verify>
  <done>
- Numpad positioned fixed at bottom
- Grid layout matches numpad.jpg
- Digit buttons are large and tappable
- +/- steppers smaller on right side
- NEXT button is blue/mint accent
- Keyboard and settings buttons have icons
- Slide-up animation works
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate numpad with workout inputs</name>
  <files>js/app.js</files>
  <action>
**Update js/app.js to use numpad for weight/reps inputs:**

1. Import numpad:
```javascript
import { initNumpad, showNumpad, hideNumpad, getNumpad } from './ui/components/numpad.js';
```

2. Initialize numpad in init():
```javascript
async function init() {
  // ... existing init code ...

  // Initialize custom numpad
  initNumpad({
    step: 2.5, // Default step for weight
    onNext: handleNumpadNext,
    onSettings: openNumpadSettings
  });

  // ... rest of init
}
```

3. Add numpad next handler:
```javascript
function handleNumpadNext(value, currentInput) {
  // Find next input in the same row or next row
  const setRow = currentInput.closest('.set-row');
  const inputs = setRow.querySelectorAll('input[type="number"]');
  const currentIndex = Array.from(inputs).indexOf(currentInput);

  if (currentIndex < inputs.length - 1) {
    // Move to next input in same row
    const nextInput = inputs[currentIndex + 1];
    showNumpad(nextInput, nextInput.value);
  } else {
    // Move to next row's first input, or close numpad
    const nextRow = setRow.nextElementSibling;
    if (nextRow && nextRow.classList.contains('set-row')) {
      const nextInput = nextRow.querySelector('input[type="number"]');
      if (nextInput) {
        showNumpad(nextInput, nextInput.value);
        return;
      }
    }
    // No more inputs, hide numpad
    hideNumpad();
  }
}

function openNumpadSettings() {
  // Future: open step size settings modal
  console.log('Numpad settings - TODO');
}
```

4. Attach numpad to number inputs:
```javascript
// In setupEventListeners or a new function
function attachNumpadToInputs() {
  document.addEventListener('focus', (e) => {
    if (e.target.matches('.number-input, input[type="number"]')) {
      e.target.setAttribute('readonly', 'readonly'); // Prevent system keyboard
      const step = e.target.step ? parseFloat(e.target.step) : 2.5;
      const numpad = getNumpad();
      if (numpad) numpad.step = step;
      showNumpad(e.target, e.target.value);
    }
  }, true);

  // Hide numpad when clicking outside
  document.addEventListener('click', (e) => {
    const numpad = getNumpad();
    if (!numpad?.isVisible) return;

    const clickedNumpad = e.target.closest('.numpad');
    const clickedInput = e.target.matches('.number-input, input[type="number"]');

    if (!clickedNumpad && !clickedInput) {
      hideNumpad();
    }
  });
}
```

5. Call attachNumpadToInputs() in init after setupEventListeners().

**Behavior notes:**
- Weight inputs use step 2.5 (kg)
- Reps inputs use step 1
- Set the appropriate step based on input class or data attribute
  </action>
  <verify>
1. Open app, go to Add Exercise modal
2. Tap on a weight input field
3. Custom numpad should slide up from bottom
4. Tap digits - they appear in input
5. Tap +/- - value increments/decrements by step
6. Tap NEXT - moves to next input
7. Tap outside numpad - it hides
  </verify>
  <done>
- Number inputs trigger custom numpad on focus
- System keyboard is prevented (readonly)
- NEXT advances through inputs logically
- Clicking outside hides numpad
- Step size varies by input type (weight vs reps)
  </done>
</task>

</tasks>

<verification>
1. Visual: Numpad looks like numpad.jpg
2. Digits: Tapping 1-9, 0, . adds to value
3. Backspace: Removes last character
4. Steppers: +/- change value by step amount
5. NEXT: Advances to next input or closes
6. Keyboard toggle: Hides numpad, shows system keyboard
7. Animation: Slides up/down smoothly
8. Z-index: Numpad appears above all content except toasts
</verification>

<success_criteria>
- Numpad matches numpad.jpg design
- All buttons functional
- Slide animation smooth
- Integrates with exercise modal inputs
- NEXT button navigates inputs correctly
- System keyboard can be accessed via toggle
- Works on mobile (touch) and desktop (click)
</success_criteria>

<output>
After completion, create `.planning/phases/02-ux-overhaul-exercise-system/02-04-SUMMARY.md`
</output>
