---
phase: 02-ux-overhaul-exercise-system
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - js/app.js
  - js/data.js
  - js/ui/components/miniPlayer.js
  - css/workout.css
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can finish active workout from workout section header"
    - "User can finish active workout from mini-player"
    - "User sees confirmation dialog before ending workout"
    - "User sees previous set values as greyed hints for ALL sets"
  artifacts:
    - path: "js/app.js"
      provides: "Finish Workout button in active workout header, confirmation dialog"
      contains: "btn-finish-workout"
    - path: "js/ui/components/miniPlayer.js"
      provides: "Close/finish button in mini-player"
      contains: "mini-player-close"
    - path: "js/data.js"
      provides: "Function to get all sets from most recent exercise session"
      exports: ["getMostRecentExerciseSets"]
    - path: "css/workout.css"
      provides: "Styling for finish button and enhanced hint labels"
      contains: "btn-finish-workout"
  key_links:
    - from: "js/app.js"
      to: "endWorkout()"
      via: "onclick handler on finish button"
      pattern: "onclick.*endWorkout|addEventListener.*click.*endWorkout"
    - from: "js/ui/components/miniPlayer.js"
      to: "window.endWorkout"
      via: "close button click handler"
      pattern: "endWorkout"
    - from: "js/app.js"
      to: "getMostRecentExerciseSets"
      via: "import and call in addSetRow"
      pattern: "getMostRecentExerciseSets"
---

<objective>
Close two verification gaps from Phase 2:
1. UX-06: Add UI buttons to trigger endWorkout() - workout section header and mini-player
2. UX-07: Show previous set hints for ALL sets (not just first set)

Purpose: Complete Phase 2 requirements that passed code-level verification but failed UI wiring checks
Output: Working finish workout buttons and comprehensive previous set hints
</objective>

<execution_context>
@/home/david/.claude/get-shit-done/workflows/execute-plan.md
@/home/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ux-overhaul-exercise-system/02-VERIFICATION.md

# Key source files
@js/app.js
@js/data.js
@js/ui/components/miniPlayer.js
@css/workout.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Finish Workout UI with Confirmation Dialog</name>
  <files>js/app.js, css/workout.css</files>
  <action>
Add UI buttons to trigger endWorkout() and implement confirmation dialog:

1. In renderTodayView() where active-workout-header is rendered (lines ~459-462 and ~489-494), add a "Finish" button next to the timer:
   ```html
   <div class="active-workout-header">
     <h3 class="active-workout-name">${workout.name || "Today's Workout"}</h3>
     <div class="active-workout-controls">
       <span class="active-workout-timer" id="workout-timer">${formatWorkoutTimer(workout.startTime)}</span>
       <button class="btn-finish-workout" onclick="confirmEndWorkout()" title="Finish workout">
         <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
           <polyline points="20 6 9 17 4 12"></polyline>
         </svg>
       </button>
     </div>
   </div>
   ```

2. Create confirmEndWorkout() function that shows a confirmation dialog:
   ```javascript
   function confirmEndWorkout() {
     const confirmed = confirm('Finish this workout?');
     if (confirmed) {
       endWorkout();
     }
   }
   window.confirmEndWorkout = confirmEndWorkout;
   ```

3. Add CSS for the finish button in workout.css:
   ```css
   .active-workout-controls {
     display: flex;
     align-items: center;
     gap: var(--spacing-sm);
   }

   .btn-finish-workout {
     width: 36px;
     height: 36px;
     border-radius: 50%;
     background: var(--primary);
     border: none;
     display: flex;
     align-items: center;
     justify-content: center;
     cursor: pointer;
     transition: all 0.2s ease;
     color: var(--text-primary);
   }

   .btn-finish-workout:hover {
     transform: scale(1.1);
     box-shadow: var(--shadow-mint);
   }

   .btn-finish-workout svg {
     color: #1a1f35;
   }
   ```
  </action>
  <verify>
    1. Run app, start a workout
    2. Verify "Finish" button appears in workout section header (checkmark icon)
    3. Click button, verify confirmation dialog appears
    4. Click OK, verify workout ends (mini-player hides, exercises show as completed)
    5. Start another workout, click Cancel on dialog, verify workout continues
  </verify>
  <done>
    - Finish button visible in active workout header with checkmark icon
    - Clicking button shows browser confirm() dialog
    - Confirming ends workout (endWorkout() called)
    - Canceling keeps workout active
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Close Button to Mini-Player</name>
  <files>js/ui/components/miniPlayer.js, css/workout.css</files>
  <action>
Add a close/finish button to the mini-player:

1. In miniPlayer.js render() method, add close button before expand button in the HTML template:
   ```html
   <div class="mini-player-content">
     <div class="mini-player-info">
       <div class="mini-player-name"></div>
       <div class="mini-player-timer"></div>
     </div>
     <div class="mini-player-actions">
       <button class="mini-player-close" aria-label="Finish workout" title="Finish workout">
         <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
           <polyline points="20 6 9 17 4 12"></polyline>
         </svg>
       </button>
       <button class="mini-player-expand" aria-label="Expand workout">
         <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
           <polyline points="18 15 12 9 6 15"></polyline>
         </svg>
       </button>
     </div>
   </div>
   ```

2. Add click handler for close button in render() after the expand button handler:
   ```javascript
   const closeBtn = this.element.querySelector('.mini-player-close');
   closeBtn.addEventListener('click', (e) => {
     e.stopPropagation();
     this.confirmClose();
   });
   ```

3. Add confirmClose() method to MiniPlayer class:
   ```javascript
   confirmClose() {
     const confirmed = confirm('Finish this workout?');
     if (confirmed && window.endWorkout) {
       window.endWorkout();
     }
   }
   ```

4. Add CSS for mini-player-actions wrapper and close button in workout.css:
   ```css
   .mini-player-actions {
     display: flex;
     align-items: center;
     gap: var(--spacing-xs);
   }

   .mini-player-close {
     flex-shrink: 0;
     width: 32px;
     height: 32px;
     border-radius: 50%;
     background: var(--primary);
     border: none;
     display: flex;
     align-items: center;
     justify-content: center;
     cursor: pointer;
     transition: all 0.2s ease;
   }

   .mini-player-close:hover {
     transform: scale(1.1);
     box-shadow: var(--shadow-mint-sm);
   }

   .mini-player-close svg {
     color: #1a1f35;
   }
   ```
  </action>
  <verify>
    1. Start workout, navigate to Library or History tab
    2. Verify mini-player shows at bottom with checkmark button (before expand arrow)
    3. Click checkmark button, verify confirmation dialog appears
    4. Click OK, verify workout ends (mini-player hides)
    5. Start another workout, verify mini-player close button works from any view
  </verify>
  <done>
    - Close/finish button (checkmark icon) visible in mini-player
    - Button positioned before expand button
    - Clicking shows confirmation dialog
    - Confirming calls window.endWorkout() and hides mini-player
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance Previous Set Hints for All Sets</name>
  <files>js/data.js, js/app.js</files>
  <action>
Implement comprehensive previous set hints for all sets (not just first):

1. In data.js, add new function getMostRecentExerciseSets() that returns ALL sets from most recent session:
   ```javascript
   /**
    * Get all sets from most recent workout session for an exercise
    * @param {Object} data - App data
    * @param {string} exerciseName - Exercise name
    * @returns {Array|null} Array of {reps, weight} for each set, or null
    */
   export function getMostRecentExerciseSets(data, exerciseName) {
     const history = getExerciseHistory(data, exerciseName);
     if (history.length === 0) return null;

     const mostRecent = history[history.length - 1];
     if (!mostRecent.sets || mostRecent.sets.length === 0) return null;

     return mostRecent.sets.map(set => ({
       reps: set.reps,
       weight: set.weight
     }));
   }
   ```

2. In app.js, import the new function:
   ```javascript
   import {
     // ... existing imports
     getMostRecentExerciseSets
   } from './data.js';
   ```

3. Modify addSetRow() to accept setIndex parameter and look up hint for that specific set:
   ```javascript
   function addSetRow(reps = '', weight = '', options = {}) {
     const setsList = document.getElementById('sets-list');
     const setIndex = setsList.children.length; // 0-based index of this new set

     let repsPlaceholder = '';
     let weightPlaceholder = '';

     // Get hints from previous workout session
     const exerciseName = document.getElementById('exercise-name')?.value;
     if (exerciseName && !reps && !weight) {
       const previousSets = getMostRecentExerciseSets(appData, exerciseName);
       if (previousSets && previousSets[setIndex]) {
         repsPlaceholder = `Last: ${previousSets[setIndex].reps}`;
         weightPlaceholder = `Last: ${previousSets[setIndex].weight}`;
       }
     }

     // ... rest of function with placeholders applied
   }
   ```

4. Update the input HTML generation to use placeholders with "Last: X" format:
   ```javascript
   const setRow = document.createElement('div');
   setRow.className = 'set-row';
   setRow.innerHTML = `
     <span>Set ${setIndex + 1}</span>
     <input type="number" class="number-input set-reps"
            value="${reps}"
            placeholder="${repsPlaceholder}"
            min="1" step="1" inputmode="numeric">
     <input type="number" class="number-input set-weight"
            value="${weight}"
            placeholder="${weightPlaceholder}"
            min="0" step="2.5" inputmode="decimal">
     <button class="btn-icon btn-remove-set" onclick="removeSetRow(this)">Ã—</button>
   `;
   ```

5. Remove the showPlaceholders option check since we now always show placeholders when data is available.
  </action>
  <verify>
    1. Have workout history with an exercise that had 4 sets
    2. Open exercise modal, select that exercise
    3. Verify first set input shows "Last: X reps" and "Last: Y kg" as placeholders
    4. Add more sets using "+ Add Set" button
    5. Verify each additional set shows the corresponding previous set's values as hints
    6. Verify set 5+ shows no placeholder (no previous data for that set)
  </verify>
  <done>
    - All set inputs show "Last: X" placeholder hints from previous workout
    - Hints are set-specific (set 1 shows previous set 1, set 2 shows previous set 2, etc.)
    - Sets beyond previous workout's count show no placeholder (graceful fallback)
    - Placeholders are visible but non-intrusive (greyed styling from existing CSS)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Exit/Cancel Workout Test:**
   - Start workout from dashboard
   - Verify Finish button in workout header works with confirmation
   - Navigate to Library, verify mini-player close button works with confirmation
   - Verify endWorkout() clears active workout state properly

2. **Previous Set Hints Test:**
   - Complete a workout with 4 sets of an exercise
   - Start new workout next day, add same exercise
   - Verify all 4 sets show "Last: X" placeholders
   - Verify adding 5th set shows no placeholder

3. **Code Verification:**
   - Grep for confirmEndWorkout in app.js
   - Grep for mini-player-close in miniPlayer.js
   - Grep for getMostRecentExerciseSets in data.js
   - Verify no console errors on page load
</verification>

<success_criteria>
- [ ] Finish button visible in active workout header (checkmark icon)
- [ ] Finish button in mini-player (checkmark icon)
- [ ] Both buttons show confirmation dialog before ending workout
- [ ] endWorkout() called on confirmation, workout ends properly
- [ ] Previous set hints show for ALL sets (not just first)
- [ ] Hints use "Last: X" format for clarity
- [ ] No regressions in existing workout logging functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-ux-overhaul-exercise-system/02-10-SUMMARY.md`
</output>
