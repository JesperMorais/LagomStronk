---
phase: 02-ux-overhaul-exercise-system
plan: 05
type: execute
wave: 2
depends_on: ["02-04"]
files_modified:
  - js/ui/components/miniPlayer.js
  - js/ui/animations/checkmark.js
  - js/ui/animations/confetti.js
  - css/workout.css
  - js/app.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "User sees previous set values as greyed-out hints in input fields"
    - "User sees checkmark pop animation when completing a set"
    - "User sees small confetti burst on set completion"
    - "User can navigate away from workout without losing progress"
    - "User sees floating mini-player showing workout name and timer"
  artifacts:
    - path: "js/ui/components/miniPlayer.js"
      provides: "Spotify-style floating workout mini-player"
      exports: ["MiniPlayer", "showMiniPlayer", "hideMiniPlayer"]
    - path: "js/ui/animations/checkmark.js"
      provides: "Set completion checkmark animation"
      exports: ["animateCheckmark"]
    - path: "js/ui/animations/confetti.js"
      provides: "Mini confetti burst for celebrations"
      exports: ["burstConfetti"]
  key_links:
    - from: "js/ui/components/miniPlayer.js"
      to: "js/app.js"
      via: "navigation handler"
      pattern: "handleNavigation|switchView"
---

<objective>
Implement workout logging UX improvements: previous set hints, completion animations, and floating mini-player for active workouts.

Purpose: Implements UX-06 (exit/cancel workout), UX-07 (previous set hints), UX-08 (completion animations). These features make workout logging feel polished and prevent accidental data loss.

Output: Mini-player component, animation modules, workout CSS, integrated into app.
</objective>

<execution_context>
@/home/david/.claude/get-shit-done/workflows/execute-plan.md
@/home/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ux-overhaul-exercise-system/02-CONTEXT.md
@.planning/phases/02-ux-overhaul-exercise-system/02-RESEARCH.md
@.planning/phases/02-ux-overhaul-exercise-system/02-04-SUMMARY.md
@js/app.js
@css/style.css
@/home/david/Dev/personal/color-palette.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create animation modules</name>
  <files>js/ui/animations/checkmark.js, js/ui/animations/confetti.js</files>
  <action>
**1. Create js/ui/animations/checkmark.js:**

Per RESEARCH.md, use Motion One for checkmark animation (or CSS if keeping deps minimal):

```javascript
// Option A: CSS-based (no dependency)
export function animateCheckmark(element) {
  // Add checkmark SVG if not present
  if (!element.querySelector('.checkmark-svg')) {
    element.innerHTML = `
      <svg class="checkmark-svg" viewBox="0 0 24 24" width="24" height="24">
        <path class="checkmark-path" fill="none" stroke="currentColor" stroke-width="3"
              d="M4 12l5 5L20 6" />
      </svg>
    `;
  }

  // Trigger animation
  element.classList.remove('checked');
  void element.offsetWidth; // Force reflow
  element.classList.add('checked');

  // Highlight row
  const row = element.closest('.set-row');
  if (row) {
    row.classList.add('completed');
  }

  return new Promise(resolve => setTimeout(resolve, 500));
}

// CSS for checkmark (add to workout.css):
// .checkmark-svg { ... }
// .checkmark-path { stroke-dasharray: 30; stroke-dashoffset: 30; }
// .checked .checkmark-path { animation: checkmark-draw 0.4s ease forwards; }
// @keyframes checkmark-draw { to { stroke-dashoffset: 0; } }
```

**2. Create js/ui/animations/confetti.js:**

Using canvas-confetti from CDN (already lightweight, 10kb):

```javascript
// Check if canvas-confetti is loaded
function getConfetti() {
  return window.confetti;
}

export function burstConfetti(element, options = {}) {
  const confetti = getConfetti();
  if (!confetti) {
    console.warn('canvas-confetti not loaded');
    return;
  }

  // Get element position for origin
  const rect = element.getBoundingClientRect();
  const x = (rect.left + rect.width / 2) / window.innerWidth;
  const y = (rect.top + rect.height / 2) / window.innerHeight;

  confetti({
    particleCount: options.particleCount || 20,
    spread: options.spread || 40,
    origin: { x, y },
    colors: options.colors || ['#D1FFC6', '#86efac', '#ffffff'],
    startVelocity: options.startVelocity || 20,
    gravity: options.gravity || 1.2,
    scalar: options.scalar || 0.8,
    disableForReducedMotion: true
  });
}

// Larger celebration for PRs
export function celebratePR(exerciseName) {
  const confetti = getConfetti();
  if (!confetti) return;

  // Double burst from sides
  confetti({
    particleCount: 50,
    angle: 60,
    spread: 55,
    origin: { x: 0, y: 0.7 },
    colors: ['#D1FFC6', '#fbbf24', '#ffffff']
  });

  setTimeout(() => {
    confetti({
      particleCount: 50,
      angle: 120,
      spread: 55,
      origin: { x: 1, y: 0.7 },
      colors: ['#D1FFC6', '#fbbf24', '#ffffff']
    });
  }, 200);
}
```

**Add canvas-confetti to index.html:**
```html
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.4/dist/confetti.browser.min.js"></script>
```
  </action>
  <verify>
- Files exist at js/ui/animations/checkmark.js and confetti.js
- In browser: `import('./js/ui/animations/confetti.js').then(m => m.burstConfetti(document.body))`
  </verify>
  <done>
- animateCheckmark draws SVG checkmark with stroke animation
- burstConfetti creates small particle burst at element position
- celebratePR creates larger two-sided burst
- canvas-confetti loaded via CDN
  </done>
</task>

<task type="auto">
  <name>Task 2: Create mini-player component</name>
  <files>js/ui/components/miniPlayer.js</files>
  <action>
Create `js/ui/components/miniPlayer.js` following RESEARCH.md pattern:

```javascript
export class MiniPlayer {
  constructor() {
    this.element = null;
    this.workout = null;
    this.timerInterval = null;
    this.startTime = null;
    this.isResting = false;
    this.restEndTime = null;
    this.isVisible = false;
  }

  render() {
    const html = `
      <div class="mini-player" id="workout-mini-player">
        <div class="mini-player-content">
          <div class="mini-player-info">
            <span class="mini-player-icon">üèãÔ∏è</span>
            <div class="mini-player-text">
              <span class="mini-player-name">Workout</span>
              <span class="mini-player-timer" id="mini-player-timer">00:00</span>
            </div>
          </div>
          <button class="mini-player-expand" id="mini-player-expand">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
            </svg>
          </button>
        </div>
      </div>
    `;

    if (!this.element) {
      document.body.insertAdjacentHTML('beforeend', html);
      this.element = document.getElementById('workout-mini-player');

      document.getElementById('mini-player-expand').addEventListener('click', () => {
        this.expand();
      });

      // Tap anywhere on mini-player to expand
      this.element.addEventListener('click', (e) => {
        if (!e.target.closest('button')) this.expand();
      });
    }
  }

  show(workoutData) {
    this.workout = workoutData;
    this.startTime = workoutData.startTime || Date.now();
    this.render();
    this.updateDisplay();
    this.startTimer();

    requestAnimationFrame(() => {
      this.element.classList.add('visible');
      this.isVisible = true;
    });
  }

  hide() {
    if (this.element) {
      this.element.classList.remove('visible');
      this.isVisible = false;
    }
    this.stopTimer();
  }

  startTimer() {
    this.stopTimer();
    this.timerInterval = setInterval(() => this.updateTimer(), 1000);
  }

  stopTimer() {
    if (this.timerInterval) {
      clearInterval(this.timerInterval);
      this.timerInterval = null;
    }
  }

  updateTimer() {
    const timerEl = document.getElementById('mini-player-timer');
    if (!timerEl) return;

    if (this.isResting && this.restEndTime) {
      // Show rest countdown
      const remaining = Math.max(0, Math.ceil((this.restEndTime - Date.now()) / 1000));
      if (remaining === 0) {
        this.isResting = false;
        this.restEndTime = null;
      }
      timerEl.textContent = `Rest: ${this.formatTime(remaining)}`;
      timerEl.classList.add('resting');
    } else {
      // Show workout duration
      const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
      timerEl.textContent = this.formatTime(elapsed);
      timerEl.classList.remove('resting');
    }
  }

  updateDisplay() {
    if (this.workout && this.element) {
      this.element.querySelector('.mini-player-name').textContent =
        this.workout.name || 'Workout in Progress';
    }
  }

  formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  startRest(durationSeconds) {
    this.isResting = true;
    this.restEndTime = Date.now() + (durationSeconds * 1000);
  }

  expand() {
    // Navigate back to workout view
    window.dispatchEvent(new CustomEvent('mini-player:expand'));
    this.hide();
  }

  destroy() {
    this.stopTimer();
    this.element?.remove();
    this.element = null;
  }
}

// Singleton and convenience functions
let miniPlayer = null;

export function initMiniPlayer() {
  if (!miniPlayer) {
    miniPlayer = new MiniPlayer();
  }
  return miniPlayer;
}

export function showMiniPlayer(workoutData) {
  initMiniPlayer();
  miniPlayer.show(workoutData);
}

export function hideMiniPlayer() {
  miniPlayer?.hide();
}

export function getMiniPlayer() {
  return miniPlayer;
}
```
  </action>
  <verify>
File exists. In browser:
`import('./js/ui/components/miniPlayer.js').then(m => m.showMiniPlayer({ name: 'Test Workout' }))`
  </verify>
  <done>
- MiniPlayer class with show, hide, expand methods
- Timer shows workout duration or rest countdown
- Tap to expand navigates back to workout
- Spotify-style fixed bottom bar appearance
  </done>
</task>

<task type="auto">
  <name>Task 3: Create workout CSS and integrate</name>
  <files>css/workout.css, js/app.js, index.html</files>
  <action>
**1. Create css/workout.css:**

```css
/* Previous Set Hints */
.set-row input::placeholder {
  color: var(--text-muted);
  font-style: italic;
}

.set-row input.has-hint::placeholder {
  color: var(--text-tertiary);
}

/* Set Completion */
.set-row {
  transition: background-color 0.3s ease;
}

.set-row.completed {
  background-color: rgba(209, 255, 198, 0.1);
}

.set-checkbox {
  width: 32px;
  height: 32px;
  border: 2px solid var(--border-color);
  border-radius: 50%;
  background: transparent;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  color: var(--mint);
}

.set-checkbox:hover {
  border-color: var(--border-mint);
}

.set-checkbox.checked {
  border-color: var(--mint);
  background: var(--mint);
  color: #0f1419;
  transform: scale(1.1);
}

/* Checkmark Animation */
.checkmark-svg {
  width: 20px;
  height: 20px;
  opacity: 0;
  transform: scale(0);
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.set-checkbox.checked .checkmark-svg {
  opacity: 1;
  transform: scale(1);
}

.checkmark-path {
  stroke-dasharray: 30;
  stroke-dashoffset: 30;
}

.set-checkbox.checked .checkmark-path {
  animation: checkmark-draw 0.4s ease 0.1s forwards;
}

@keyframes checkmark-draw {
  to {
    stroke-dashoffset: 0;
  }
}

/* Mini Player */
.mini-player {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 64px;
  background: rgba(35, 44, 51, 0.95);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-top: 1px solid var(--border-color);
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 100;
  padding: 0 var(--spacing-md);
  max-width: 480px;
  margin: 0 auto;
}

.mini-player.visible {
  transform: translateY(0);
}

/* Adjust nav when mini-player visible */
body.has-mini-player .bottom-nav {
  transform: translateY(-64px);
}

body.has-mini-player .main-content {
  padding-bottom: calc(var(--nav-height) + 64px + var(--spacing-lg));
}

.mini-player-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: 100%;
}

.mini-player-info {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.mini-player-icon {
  font-size: 1.5rem;
}

.mini-player-text {
  display: flex;
  flex-direction: column;
}

.mini-player-name {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text-primary);
}

.mini-player-timer {
  font-size: 0.75rem;
  color: var(--text-secondary);
  font-variant-numeric: tabular-nums;
}

.mini-player-timer.resting {
  color: var(--amber);
}

.mini-player-expand {
  background: rgba(209, 255, 198, 0.15);
  border: 1px solid rgba(209, 255, 198, 0.3);
  border-radius: 8px;
  padding: 8px 16px;
  color: var(--mint);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.mini-player-expand:hover {
  background: rgba(209, 255, 198, 0.25);
}

/* Warmup Sets (from CONTEXT.md) */
.set-row.warmup {
  background-color: rgba(251, 191, 36, 0.1);
  border-color: rgba(251, 191, 36, 0.3);
}

.warmup-badge {
  font-size: 0.625rem;
  padding: 2px 6px;
  background: rgba(251, 191, 36, 0.2);
  color: var(--amber);
  border-radius: 4px;
  text-transform: uppercase;
  font-weight: 600;
}
```

**2. Update index.html:**
```html
<link rel="stylesheet" href="css/workout.css">
```

**3. Update js/app.js:**

Add imports:
```javascript
import { animateCheckmark } from './ui/animations/checkmark.js';
import { burstConfetti } from './ui/animations/confetti.js';
import { showMiniPlayer, hideMiniPlayer, initMiniPlayer } from './ui/components/miniPlayer.js';
```

Add active workout state:
```javascript
let activeWorkout = null; // { name, startTime, exercises }
```

Update navigation to show/hide mini-player:
```javascript
function switchView(viewName) {
  // ... existing code ...

  // Show mini-player when navigating away from active workout
  if (activeWorkout && viewName !== 'today') {
    showMiniPlayer({
      name: activeWorkout.name || "Today's Workout",
      startTime: activeWorkout.startTime
    });
    document.body.classList.add('has-mini-player');
  } else {
    hideMiniPlayer();
    document.body.classList.remove('has-mini-player');
  }

  // ... rest of existing code
}
```

Listen for mini-player expand:
```javascript
window.addEventListener('mini-player:expand', () => {
  switchView('today');
});
```

Add set completion handler (update addSetRow or create new function):
```javascript
function handleSetComplete(checkbox, setRow) {
  if (checkbox.classList.contains('checked')) {
    checkbox.classList.remove('checked');
    setRow.classList.remove('completed');
    return;
  }

  checkbox.classList.add('checked');
  animateCheckmark(checkbox);
  burstConfetti(checkbox);
  setRow.classList.add('completed');

  // Haptic feedback
  if (navigator.vibrate) navigator.vibrate(50);
}
```

Update addSetRow to include checkbox:
```javascript
function addSetRow(reps = 10, weight = 20, previousSet = null) {
  // ... existing code ...
  setRow.innerHTML = `
    <button class="set-checkbox" onclick="handleSetComplete(this, this.closest('.set-row'))">
      <svg class="checkmark-svg" viewBox="0 0 24 24">
        <path class="checkmark-path" fill="none" stroke="currentColor" stroke-width="3" d="M4 12l5 5L20 6"/>
      </svg>
    </button>
    <span>Set ${setNumber}</span>
    <!-- ... rest with placeholder hints -->
    <input type="number" class="number-input set-reps"
           placeholder="${previousSet?.reps || ''}"
           value="${reps}" min="1" max="100">
    <!-- ... etc -->
  `;
}
```

Make handleSetComplete global:
```javascript
window.handleSetComplete = handleSetComplete;
```
  </action>
  <verify>
1. Open app, add exercise with sets
2. See greyed placeholder hints if previous workout data exists
3. Tap checkbox - checkmark animates, confetti bursts, row highlights
4. Navigate to History - mini-player appears at bottom
5. Tap mini-player - returns to Today view
  </verify>
  <done>
- Previous set hints show as greyed placeholders
- Set checkbox animates with checkmark on tap
- Small confetti burst on set completion
- Mini-player shows when navigating away from active workout
- Mini-player tap returns to workout
- Warmup set styling available
  </done>
</task>

</tasks>

<verification>
1. Placeholder hints: Start new workout, add exercise done before - see previous values greyed
2. Checkmark: Tap set checkbox - checkmark draws with animation
3. Confetti: Particles burst from checkbox location
4. Row highlight: Completed set row has mint tint
5. Mini-player: Navigate away during workout - bar slides up from bottom
6. Timer: Mini-player shows elapsed time updating
7. Expand: Tap mini-player - returns to workout view
</verification>

<success_criteria>
- Previous set values show as placeholder hints
- Checkmark animation is smooth spring-like motion
- Confetti uses mint colors
- Completed row stays highlighted
- Mini-player appears when navigating away from active workout
- Mini-player shows workout name and timer
- Mini-player tap navigates back to workout
- No system keyboard conflicts with mini-player
</success_criteria>

<output>
After completion, create `.planning/phases/02-ux-overhaul-exercise-system/02-05-SUMMARY.md`
</output>
